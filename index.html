<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta http-equiv="Cache-Control" content="no-store, max-age=0">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Mr Samuels’ Grade 10 English Hub</title>
<style>
  :root{
    --bg:#040713; --panel:rgba(8,14,34,.72); --text:#e7f2ff; --muted:#a8bfdd;
    --accent:#00f5d4; --accent2:#ff5e57; --accent3:#8a5cff; --accent4:#fca311;
    --good:#2ecc71; --bad:#ff4d6d; --theme:#8a5cff;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;color:var(--text);font-family:Inter,system-ui,Segoe UI,Roboto,Arial;background:#000}

  /* Futuristic chrome */
  .bg3d{position:fixed; inset:0; z-index:-2; overflow:hidden; perspective:1200px;
    background:radial-gradient(1200px 600px at 10% -10%, #102153 0, #0c1736 35%, #070b1a 65%, #040713 100%), #040713;}
  .bg3d::before{content:""; position:absolute; inset:-20vh -20vw; z-index:-2;
    background:repeating-linear-gradient(to right, rgba(0,245,212,.08) 0 1px, transparent 1px 60px),
               repeating-linear-gradient(to bottom, rgba(138,92,255,.07) 0 1px, transparent 1px 60px);
    transform:rotateX(60deg) translateZ(-200px) translateY(15vh); filter:drop-shadow(0 0 18px rgba(0,245,212,.15));}
  .stars{position:absolute; inset:0; z-index:-1; pointer-events:none;
    background:radial-gradient(2px 2px at 20% 30%, rgba(255,255,255,.28), transparent 40%),
               radial-gradient(2px 2px at 70% 60%, rgba(255,255,255,.18), transparent 40%),
               radial-gradient(2px 2px at 40% 80%, rgba(255,255,255,.20), transparent 40%);
    animation: twinkle 6s linear infinite alternate;}
  @keyframes twinkle{
    0%{opacity:.6; transform:translateY(0)}
    100%{opacity:1; transform:translateY(-2px)}
  }

  .wrap{max-width:1320px;margin:0 auto;padding:18px}
  header{position:relative; display:flex; align-items:center; gap:12px; margin-bottom:16px;}
  .holo{position:absolute; inset:-14px -14px auto -14px; height:86px; z-index:-1;
    background:linear-gradient(90deg, rgba(0,245,212,.14), rgba(138,92,255,.14) 40%, rgba(255,94,87,.14) 80%);
    border:1px solid rgba(255,255,255,.14); border-radius:16px; box-shadow: inset 0 1px 0 rgba(255,255,255,.05), inset 0 0 60px rgba(138,92,255,.08), 0 10px 40px rgba(0,0,0,.45);}
  .brand{font-weight:900;font-size:26px; letter-spacing:.2px}
  .neon{background:linear-gradient(90deg,var(--accent),var(--accent3));-webkit-background-clip:text;background-clip:text;color:transparent; text-shadow:0 0 12px rgba(0,245,212,.25)}
  .badge{background:linear-gradient(90deg,var(--accent3),var(--accent2));padding:6px 10px;border-radius:999px;font-size:12px;border:1px solid rgba(255,255,255,.18)}
  .tabs{margin-left:auto;display:flex;flex-wrap:wrap;gap:10px}
  .tab-btn{border:1px solid rgba(255,255,255,.12); padding:12px 16px; border-radius:14px;background:linear-gradient(180deg,#121a38,#0d1430);color:#e7f2ff; cursor:pointer; font-weight:800}
  .tab-btn.active{color:#061314; background:linear-gradient(180deg,var(--accent) 0,var(--accent3) 100%)}

  .chip{border:1px solid rgba(255,255,255,.2);padding:8px 12px;border-radius:999px;background:linear-gradient(180deg,#121a38,#0d1430);color:#cfe7ff;font-weight:700}

  .card{position:relative; background:var(--panel); border:1px solid rgba(255,255,255,.08); border-radius:20px; padding:18px}
  .flex{display:flex;gap:16px;flex-wrap:wrap}.row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}.grow{flex:1 1 360px}
  .muted{color:var(--muted)} .big{font-size:18px}
  .grid-2{display:grid;grid-template-columns:1.2fr 1fr;gap:16px}
  @media (max-width:980px){.grid-2{grid-template-columns:1fr}}
  .statgrid{display:grid;grid-template-columns:repeat(4,1fr);gap:14px}
  @media (max-width:900px){.statgrid{grid-template-columns:repeat(2,1fr)}}
  .stat{background:linear-gradient(180deg,#101837,#0c1330);border:1px solid rgba(255,255,255,.12);border-radius:16px;padding:14px;box-shadow:0 8px 24px rgba(0,0,0,.25), inset 0 0 40px rgba(138,92,255,.07)}
  .stat h4{margin:0 0 6px 0;font-size:13px;color:#bcd1ff}
  .stat .v{font-size:32px;font-weight:1000;letter-spacing:.5px}
  .pill{display:inline-block;padding:6px 10px;border-radius:999px;background:#101a34;border:1px solid rgba(255,255,255,.12);color:#a8bfdd;font-size:12px}
  .btn{border:0;padding:10px 14px;border-radius:12px;cursor:pointer;font-weight:800;color:#061314;background:linear-gradient(180deg,var(--accent) 0,var(--accent3) 100%)}
  .btn.secondary{color:#cfe7ff;background:linear-gradient(180deg,#1b2546 0,#121c3a 100%);border:1px solid rgba(255,255,255,.12)}
  .btn.warn{color:#130a00;background:linear-gradient(180deg,#ffd166 0,var(--accent4) 100%)}
  canvas{background:linear-gradient(180deg,#0c1228,#0a0f21);border:1px solid rgba(255,255,255,.12);border-radius:16px;max-width:100%}

  /* Dashboard hero (3D look) */
  .hero3d{
    position:relative; margin:6px 0 16px; padding:22px;
    border-radius:22px; overflow:hidden;
    background:
      radial-gradient(1000px 400px at 10% -10%, rgba(0,245,212,.12), transparent 60%),
      radial-gradient(800px 400px at 90% -10%, rgba(138,92,255,.16), transparent 65%),
      linear-gradient(180deg, rgba(9,14,32,.75), rgba(7,11,26,.85));
    border:1px solid rgba(255,255,255,.14);
    box-shadow:
      inset 0 1px 0 rgba(255,255,255,.06),
      0 30px 60px rgba(0,0,0,.55), 0 0 80px rgba(138,92,255,.18);
    transform-style:preserve-3d;
  }
  .hero-inner{display:flex;gap:16px;align-items:center;flex-wrap:wrap}
  .hero-title{font-size:clamp(20px,4.6vw,42px);font-weight:1000;letter-spacing:1px;margin:0;
    background:linear-gradient(180deg,#00f5d4,#8a5cff 70%); -webkit-background-clip:text;background-clip:text;color:transparent;
    text-shadow:0 0 16px rgba(0,245,212,.28);}
  .hero-sub{color:#bcd1ff;font-weight:700;margin-top:2px}
  .hero-right{margin-left:auto; text-align:right}
  #zaClock{font-weight:1000;font-size:clamp(16px,3.6vw,28px)}
  .tile-grid{display:grid;grid-template-columns:repeat(6,1fr);gap:12px;margin-top:14px; position:relative; z-index:1;}
  @media (max-width:1000px){.tile-grid{grid-template-columns:repeat(3,1fr)}}
  @media (max-width:560px){.tile-grid{grid-template-columns:repeat(2,1fr)}}
  .tile{
    display:flex;align-items:center;justify-content:center; text-align:center;
    border-radius:16px; padding:18px 12px; min-height:86px;
    background:linear-gradient(180deg,#121a38,#0d1430); border:1px solid rgba(255,255,255,.14);
    font-weight:900; font-size:18px; color:#dff3ff; cursor:pointer;
    box-shadow:0 6px 18px rgba(0,0,0,.35), inset 0 0 40px rgba(0,245,212,.06);
    transform:translateZ(0); will-change:transform;
  }
  .tile:hover{transform:translateY(-2px)}
  .tile .sm{display:block;font-weight:700;color:#a8bfdd;font-size:12px;margin-top:6px}

  /* Road Rage HUD & controls */
  .hud{display:flex;gap:10px;flex-wrap:wrap;justify-content:center}
  .gauges{display:flex;gap:14px;flex-wrap:wrap;justify-content:center;margin-top:8px}
  .gauge{width:230px;height:14px;border-radius:12px;border:1px solid rgba(255,255,255,.16);background:linear-gradient(180deg,#0f1836,#0b1230);position:relative;overflow:hidden}
  .gauge .fill{position:absolute;left:0;top:0;height:100%;width:0%;background:linear-gradient(90deg,#00f5d4,#8a5cff);transition:width .15s}
  .gauge.nitro .fill{background:linear-gradient(90deg,#ff2b2b,#ff6a00)}
  .overlayQ{position:absolute;inset:0;background:rgba(7,11,26,.8);display:none;align-items:center;justify-content:center;z-index:60}
  .overlayCard{max-width:620px;background:linear-gradient(180deg,#0f1837,#0b1230);border:2px solid var(--theme);border-radius:16px;padding:16px}
  .overlayCard .opt{display:grid;grid-template-columns:1fr;gap:10px}
  .gameOver{position:absolute;inset:0;display:none;align-items:center;justify-content:center;background:rgba(5,0,0,.65);z-index:70;color:#ff1e1e;font-weight:900;font-size:44px;text-shadow:0 0 22px #300}

  /* On-canvas thumb controls */
  .overlay-controls{ position:absolute; inset:0; z-index:50; pointer-events:none; }
  .oc-left,.oc-right,.oc-top{ position:absolute; display:flex; gap:12px; pointer-events:auto; }
  .oc-left{ left:12px; bottom:12px; }
  .oc-right{ right:12px; bottom:12px; flex-direction:column; }
  .oc-top{ right:12px; top:12px; }
  .oc-btn{ width:86px; height:86px; border-radius:16px; border:2px solid rgba(255,255,255,.14);
           background:linear-gradient(180deg,#0d1736,#0b1230); color:#e7f2ff; font-weight:900; touch-action:none; }
  .oc-btn:active{ transform:scale(.98); }
  @media (min-width:900px){ .oc-btn{ width:96px; height:96px; } }
  @media (max-width:420px){ .oc-btn{ width:74px; height:74px; } }

  /* 30 Seconds */
  .def-box{background:linear-gradient(180deg,#0f1837,#0b1230);border:1px solid rgba(255,255,255,.12);border-radius:12px;padding:12px}
  #secInput{width:100%;padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,.16);background:#0b1230;color:#e7f2ff;font-size:16px}
  .hourglass{width:70px;height:auto}

  /* Hangman */
  .kbd{display:grid;grid-template-columns:repeat(9,1fr);gap:6px}
  .kbd button{padding:8px;border-radius:10px;border:1px solid rgba(255,255,255,.12);background:#16224b;color:#e7f2ff;font-weight:800}
  .kbd button[disabled]{opacity:.5}

  /* Millionaire */
  .opt{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .ladder{list-style:none;margin:0;padding:0;display:grid;gap:4px}
  .ladder li{padding:6px 10px;border-radius:10px;background:#0f1837;border:1px solid rgba(255,255,255,.12);display:flex;justify-content:space-between}
  .ladder li.active{background:linear-gradient(180deg,#1b2546,#121c3a);border-color:var(--theme)}

  /* Toast + splash logo */
  .toast{position:fixed;left:50%;bottom:24px;transform:translateX(-50%);background:#0d1640;border:1px solid rgba(255,255,255,.14);color:#dff3ff;padding:10px 14px;border-radius:999px;opacity:0;transition:opacity .2s, transform .2s;pointer-events:none;z-index:200}
  .toast.show{opacity:1;transform:translateX(-50%) translateY(-6px)}
  .confetti-piece{position:fixed;top:-10px;left:0;width:8px;height:14px;opacity:.9;pointer-events:none;border-radius:2px;transition:transform 1s linear, opacity .3s ease-out}

  section{opacity:1; transition:opacity .28s ease;}
  .splash{position:fixed; inset:0; display:none; align-items:center; justify-content:center;
    background:linear-gradient(180deg,rgba(5,8,20,.72),rgba(4,7,19,.82)); backdrop-filter: blur(4px); z-index:300;}
  .logo3d{position:relative; padding:24px 28px; border-radius:22px;
    background:radial-gradient(120px 80px at 50% 0%, rgba(255,70,70,.18), transparent 60%); box-shadow: inset 0 0 40px rgba(255,80,60,.18), 0 30px 60px rgba(0,0,0,.6)}
  .logo3d h1{margin:0; font-size: clamp(22px, 6vw, 46px); letter-spacing: 2px; font-weight: 1000; text-transform: uppercase;
    background:linear-gradient(180deg,#ff2b2b,#ff6a00 60%, #ffd166 95%); -webkit-background-clip:text;background-clip:text;color:transparent;
    text-shadow:0 0 12px rgba(255,40,40,.5),0 0 30px rgba(255,90,0,.35), 0 8px 18px rgba(0,0,0,.6);}
  .emoji-cloud{position:absolute; inset:-22px -26px; pointer-events:none; filter:drop-shadow(0 8px 12px rgba(0,0,0,.45))}
  .emoji{position:absolute; font-size:clamp(18px,4vw,32px)} .e1{top:-10px;left:-6px} .e2{top:-8px;right:-8px} .e3{bottom:-8px;left:-10px} .e4{bottom:-12px;right:-6px}
</style>
</head>
<body>
<div class="bg3d"><div class="stars"></div></div>

<!-- Splash -->
<div id="splash" class="splash" aria-hidden="true">
  <div class="logo3d">
    <div class="emoji-cloud"><div class="emoji e1">📚</div><div class="emoji e2">📚</div><div class="emoji e3">📚</div><div class="emoji e4">📚</div></div>
    <h1>MR SAMUELS ENGLISH HL</h1>
  </div>
</div>

<div class="wrap">
  <div class="holo"></div>
  <header>
    <div class="brand">Mr Samuels’ <span class="neon">Grade 10 English Hub</span></div>
    <span id="studentBadge" class="badge">Guest Mode</span>
    <!-- Not a tab button (prevents tab breakage) -->
    <button id="btnStudent" class="chip">Set Student</button>
    <div class="tabs">
      <button class="tab-btn active" data-tab="dash">Dashboard</button>
      <button class="tab-btn" data-tab="hangman">Hangman</button>
      <button class="tab-btn" data-tab="seconds">30 Seconds</button>
      <button class="tab-btn" data-tab="million">Millionaire</button>
      <button class="tab-btn" data-tab="driver">Road Rage</button>
      <button class="tab-btn" data-tab="study">Study</button>
    </div>
  </header>

  <!-- DASHBOARD -->
  <section id="dash" class="card">
    <div class="hero3d" id="hero3d">
      <div class="hero-inner">
        <div>
          <h1 class="hero-title">Welcome, Grade 10s 🚀</h1>
          <div class="hero-sub">Tap a tile to jump straight into a game or study pack.</div>
        </div>
        <div class="hero-right">
          <div class="pill">Africa/Johannesburg</div>
          <div id="zaClock">--:--:--</div>
        </div>
      </div>
      <div class="tile-grid" id="dashTiles">
        <button class="tile" data-go="hangman">Hangman<span class="sm">Vocabulary</span></button>
        <button class="tile" data-go="seconds">30 Seconds<span class="sm">Speed defs</span></button>
        <button class="tile" data-go="million">Millionaire<span class="sm">15-step</span></button>
        <button class="tile" data-go="driver">Road Rage<span class="sm">Drive & quiz</span></button>
        <button class="tile" data-go="study">Study<span class="sm">Shakespeare pack</span></button>
        <button class="tile" data-go="dash">Dashboard<span class="sm">Stats</span></button>
      </div>
    </div>

    <div class="statgrid">
      <div class="stat"><h4>Merits</h4><div class="v" id="s_merits">0</div></div>
      <div class="stat"><h4>Hangman Wins</h4><div class="v" id="s_hm_wins">0</div></div>
      <div class="stat"><h4>30 Seconds — Fastest Solve</h4><div class="v" id="s_30_fast">—</div></div>
      <div class="stat"><h4>30 Seconds — Correct Total</h4><div class="v" id="s_30_total">0</div></div>
      <div class="stat"><h4>Millionaire — Best Step</h4><div class="v" id="s_mil_best">0 / 15</div></div>
      <div class="stat"><h4>Millionaire — Correct</h4><div class="v" id="s_mil_correct">0</div></div>
      <div class="stat"><h4>Millionaire — Answered</h4><div class="v" id="s_mil_answered">0</div></div>
      <div class="stat"><h4>Road Rage — Best Run</h4><div class="v" id="s_drv_best">0 m</div></div>
    </div>
  </section>

  <!-- HANGMAN -->
  <section id="hangman" class="card" style="display:none">
    <div class="flex">
      <div class="grow" style="max-width:520px">
        <h2>Mr Samuels – Grade 10 HL Hangman</h2>
        <canvas id="hmCanvas" width="460" height="300"></canvas>
      </div>
      <div class="grow">
        <div class="row">
          <span class="pill">Lives: <span id="hmLives">6</span></span>
          <span class="pill">Wins: <span id="hmWins">0</span></span>
        </div>
        <div id="hmSlots" class="big" style="letter-spacing:6px;margin-top:8px">_ _ _</div>
        <div id="hmUsed" class="muted" style="margin-top:4px">Used: —</div>
        <div class="row" style="margin-top:8px">
          <button id="hmHint" class="btn secondary">Show Hint</button>
          <button id="hmNew" class="btn">New Word</button>
          <button id="hmReveal" class="btn warn">Reveal</button>
        </div>
        <div id="hmHintBox" class="muted" style="margin-top:8px;display:none"></div>
        <div id="hmResult" class="big" style="margin-top:8px"></div>
        <div id="hmKeys" class="kbd" style="margin-top:10px"></div>
      </div>
    </div>
  </section>

  <!-- 30 SECONDS -->
  <section id="seconds" class="card" style="display:none">
    <div class="row" style="justify-content:space-between;align-items:center">
      <div class="pill">Round Score: <span id="secScore">0</span></div>
      <div class="row" style="gap:10px;align-items:center">
        <svg id="hourglass" viewBox="0 0 100 160" class="hourglass" aria-label="Timer">
          <defs>
            <clipPath id="clipTop"><polygon points="20,20 80,20 50,80"/></clipPath>
            <clipPath id="clipBottom"><polygon points="20,140 80,140 50,80"/></clipPath>
          </defs>
          <rect id="hgTop" x="20" y="20" width="60" height="60" fill="#fca311" clip-path="url(#clipTop)"/>
          <rect id="hgBottom" x="20" y="140" width="60" height="0" fill="#fca311" clip-path="url(#clipBottom)"/>
          <rect id="hgStream" x="48.5" y="78" width="3" height="0" fill="#fca311" visibility="hidden"/>
          <polygon points="20,20 80,20 50,80 20,140 80,140 50,80" fill="none" stroke="#cfe7ff" stroke-width="4"/>
          <rect x="15" y="10" width="70" height="8" fill="#cfe7ff"/><rect x="15" y="142" width="70" height="8" fill="#cfe7ff"/>
        </svg>
        <span id="secTime" class="pill">30</span>
      </div>
    </div>
    <div id="secDef" class="def-box" style="margin:10px 0 8px">Tap Start to begin…</div>
    <input id="secInput" type="text" placeholder="Type the word here…" autocomplete="off" />
    <div class="row" style="margin-top:10px">
      <button id="secStart" class="btn">Start 30-second Round</button>
      <button id="secSkip" class="btn secondary" disabled>Skip</button>
      <button id="secGive" class="btn warn" disabled>Give Answer</button>
      <span class="pill">Correct total: <span id="secTotal">0</span></span>
    </div>
    <div id="secFeedback" class="big" style="margin-top:8px"></div>
    <div id="secLast" class="muted" style="margin-top:6px"></div>
  </section>

  <!-- MILLIONAIRE -->
  <section id="million" class="card theming" style="display:none">
    <div class="grid-2">
      <div>
        <div class="row" style="justify-content:space-between;align-items:center">
          <div class="pill">Question <span id="milStep">1</span>/15</div>
          <div class="row">
            <span class="mil-cat"><span class="mil-dot" id="milDot" style="display:inline-block;width:10px;height:10px;border-radius:50%;background:var(--theme);margin-right:6px"></span>
              <b id="milCat">—</b></span>
            <button id="mil5050" class="btn secondary">50:50</button>
            <button id="milSkip" class="btn secondary">Skip</button>
            <button id="milQuit" class="btn warn">Quit</button>
          </div>
        </div>
        <div id="milQ" class="def-box" style="margin-top:10px;font-weight:700">Tap “Start New Game”.</div>
        <div class="opt" id="milOpts" style="margin-top:10px"></div>
        <div id="milFeedback" class="big" style="margin-top:10px"></div>
        <div class="row" style="margin-top:10px"><button id="milStart" class="btn">Start New Game</button></div>
      </div>
      <div><ul class="ladder" id="milLadder"></ul></div>
    </div>
  </section>

  <!-- ROAD RAGE -->
  <section id="driver" class="card" style="display:none">
    <div class="row hud" style="justify-content:space-between">
      <span class="pill">Stage: <b id="drvStageName">—</b></span>
      <span class="pill">Time Left: <b id="drvTime">30</b>s</span>
      <span class="pill">Distance: <b id="drvDist">0</b> m</span>
      <span class="pill">Speed: <b id="drvSpeed">50</b> m/s</span>
      <span class="pill">Score: <b id="drvScore">0</b></span>
      <span class="pill">Lives: <b id="drvLives">3</b></span>
      <button id="drvStart" class="btn">Start Run</button>
      <button id="drvPause" class="btn secondary">Pause</button>
    </div>
    <div class="gauges">
      <div class="gauge" id="speedGauge" aria-label="Speed"><div class="fill" id="speedFill"></div></div>
      <div class="gauge nitro" id="nitroGauge" aria-label="Nitro" style="display:none"><div class="fill" id="nitroFill"></div></div>
    </div>
    <div style="position:relative;display:flex;justify-content:center">
      <canvas id="drvCanvas" width="360" height="540" style="border-radius:16px;border:1px solid rgba(255,255,255,.14)"></canvas>

      <!-- On-canvas thumb controls -->
      <div class="overlay-controls" aria-hidden="false">
        <div class="oc-left">
          <button id="btnLeft"  class="oc-btn"  aria-label="Steer Left">⬅️</button>
          <button id="btnRight" class="oc-btn"  aria-label="Steer Right">➡️</button>
        </div>
        <div class="oc-right">
          <button id="pedalAccel" class="oc-btn" aria-label="Accelerate">⏫</button>
          <button id="pedalBrake" class="oc-btn" aria-label="Brake">⏬</button>
        </div>
        <!-- Fire button at top-right -->
        <div class="oc-top">
          <button id="btnFire" class="oc-btn" aria-label="Fire">🔥</button>
        </div>
      </div>

      <div id="drvOverlay" class="overlayQ">
        <div class="overlayCard">
          <div class="big" id="drvQ">Question here</div>
          <div id="drvOpts" class="opt" style="margin-top:10px"></div>
        </div>
      </div>
      <div id="drvGameOver" class="gameOver">GAME OVER</div>
    </div>
  </section>

  <!-- STUDY -->
  <section id="study" class="card" style="display:none">
    <div class="subtabs">
      <button class="sub-btn" data-sub="studyVocab">Vocabulary</button>
      <button class="sub-btn" data-sub="lotf">Lord of the Flies</button>
      <button class="sub-btn active" data-sub="shakespeare">Shakespeare</button>
    </div>
    <div id="studyVocab" style="display:none">
      <p>Core terms used across the games (sample): metaphor, iambic pentameter, hyperbole, symbolism, tragedy, conflict, conch, glasses.</p>
    </div>
    <div id="lotf" style="display:none">
      <p><b>Themes:</b> civilization vs. savagery; leadership; fear.</p>
      <p><b>Symbols:</b> conch (order), Piggy’s glasses (reason), the beast (inner evil).</p>
    </div>
    <div id="shakespeare">
      <p><b>Sonnet 18</b>: comparisons to a summer’s day; the “eye of heaven” (sun); eternal lines give immortality.</p>
      <p><b>Balcony Scene</b>: names vs identity; “Wherefore art thou Romeo?” means “Why are you Romeo?”.</p>
      <p><b>Form:</b> iambic pentameter; rhyme scheme ABAB CDCD EFEF GG.</p>
    </div>
  </section>
</div>

<div class="toast" id="toast">Saved</div>

<script>
/* ========= helpers & sounds ========= */
var AC;
function safeAC(){ AC=AC||new (window.AudioContext||window.webkitAudioContext)(); return AC; }
function tone(f,d,type,g){ try{var ac=safeAC(), o=ac.createOscillator(), v=ac.createGain(); o.type=type; o.frequency.value=f; o.connect(v); v.connect(ac.destination);
  var t=ac.currentTime; v.gain.setValueAtTime(0.0001,t); v.gain.exponentialRampToValueAtTime(g||0.2,t+0.01); v.gain.exponentialRampToValueAtTime(0.0001,t+(d||0.2)); o.start(t); o.stop(t+(d||0.2)+.02);}catch(e){}}
function clickBeep(){ tone(880,.05,"square",.08); }
function beep(){ tone(520,.12,"sine",.12); }
function pop(){ tone(1040,.08,"square",.12); }
function screech(){ try{var ac=safeAC(), n=ac.createBufferSource(), g=ac.createGain(), bp=ac.createBiquadFilter();
  var b=ac.createBuffer(1, ac.sampleRate*.35, ac.sampleRate), d=b.getChannelData(0);
  for(var i=0;i<d.length;i++){ d[i]=(Math.random()*2-1)*Math.pow(1-i/d.length,1.1); }
  n.buffer=b; bp.type="bandpass"; bp.frequency.value=3000; g.gain.value=.25; n.connect(bp); bp.connect(g); g.connect(ac.destination); n.start(); }catch(e){}}
function crashSound(){ try{var ac=safeAC(), dur=.5, b=ac.createBuffer(1, ac.sampleRate*dur, ac.sampleRate), d=b.getChannelData(0);
  for(var i=0;i<d.length;i++){d[i]=(Math.random()*2-1)*Math.pow(1-i/d.length,1.2);} var s=ac.createBufferSource(); s.buffer=b; var g=ac.createGain(); g.gain.value=.5;
  var lp=ac.createBiquadFilter(); lp.type="lowpass"; lp.frequency.value=900; s.connect(lp); lp.connect(g); g.connect(ac.destination); s.start(); }catch(e){}}
function ignitionSound(){ try{var ac=safeAC(), t=ac.currentTime, o=ac.createOscillator(), g=ac.createGain(); o.type="triangle"; o.frequency.setValueAtTime(120,t);
  g.gain.setValueAtTime(0.0001,t); g.gain.exponentialRampToValueAtTime(0.22,t+.06); g.gain.exponentialRampToValueAtTime(0.0001,t+.8);
  o.connect(g); g.connect(ac.destination); o.start(t); o.stop(t+.85);}catch(e){}}
function fireSound(){ tone(220,.06,"square",.18); setTimeout(function(){tone(330,.05,"square",.14)},40); }
function hitSound(){ tone(120,.08,"sawtooth",.18); }
function cheer(){ tone(660,.12,"sine",.15); setTimeout(function(){tone(880,.12,"sine",.15)},120); }
function themeJingle(){ try{var ac=safeAC(), g=ac.createGain(); g.gain.value=.15; g.connect(ac.destination);
  var steps=[0,3,7,12,7,12,15]; for(var i=0;i<steps.length;i++){var o=ac.createOscillator(); o.type="triangle"; o.frequency.value=220*Math.pow(2,steps[i]/12); o.connect(g);
    var t=ac.currentTime+i*0.12; o.start(t); o.stop(t+0.11);} }catch(e){} }
function $(id){return document.getElementById(id)}
function toast(msg){var t=$("toast"); t.textContent=msg; t.className="toast show"; setTimeout(function(){t.className="toast";},1200);}
function confetti(n){ n=n||60; for(var i=0;i<n;i++){ var d=document.createElement("div"); d.className="confetti-piece";
  var x=Math.random()*100; d.style.left=x+"vw"; d.style.background="hsl("+Math.floor(Math.random()*360)+",90%,60%)";
  document.body.appendChild(d); var dx=(Math.random()*20-10), dy=100+Math.random()*10;
  (function(el,dx,dy){ setTimeout(function(){ el.style.transform="translate("+dx+"vw,"+dy+"vh) rotate("+(Math.random()*360)+"deg)"; el.style.opacity=.95; },10); })(d,dx,dy);
  (function(el){ setTimeout(function(){ el.style.opacity=0; setTimeout(function(){ if(el&&el.parentNode) el.parentNode.removeChild(el); },300); },1000); })(d);
}}
/* ========= local stats ========= */
var STORE_KEY="ms_eng10_stats";
function loadObj(k,def){ try{ return JSON.parse(localStorage.getItem(k))||def; }catch(e){ return def; } }
function saveObj(k,v){ try{ localStorage.setItem(k, JSON.stringify(v)); }catch(e){} }
var STATS = loadObj(STORE_KEY,{ merits:0, hmWins:0, secFast:null, secTotal:0, milBest:0, milCorrect:0, milAnswered:0, drvBest:0 });
function refreshDash(){
  $("s_merits").textContent=STATS.merits|0; $("s_hm_wins").textContent=STATS.hmWins|0;
  $("s_30_fast").textContent=STATS.secFast? (STATS.secFast.toFixed(1)+"s") : "—";
  $("s_30_total").textContent=STATS.secTotal|0;
  $("s_mil_best").textContent=(STATS.milBest|0)+" / 15";
  $("s_mil_correct").textContent=STATS.milCorrect|0;
  $("s_mil_answered").textContent=STATS.milAnswered|0;
  $("s_drv_best").textContent=(STATS.drvBest|0)+" m";
}
function addMerits(n){ STATS.merits=(STATS.merits|0)+n; saveObj(STORE_KEY,STATS); refreshDash(); toast("🏅 +" + n + (n>1?" merits":" merit")); }
refreshDash();

/* ========= TABS (robust + hash + remember) ========= */
(function(){
  var GAME_TABS = {hangman:1,seconds:1,million:1,driver:1,study:1};
  var buttons = document.querySelectorAll('.tab-btn[data-tab]'); // only real tab buttons
  var sections = document.querySelectorAll('section');
  var LAST_KEY = "ms_eng10_lasttab";

  function setActive(id){
    for (var k=0;k<buttons.length;k++){
      var b = buttons[k];
      if(b.getAttribute('data-tab')===id) b.classList.add('active'); else b.classList.remove('active');
    }
  }
  function showTab(id){
    if(!id) id='dash';
    // show/hide sections
    for (var i=0;i<sections.length;i++){
      var s = sections[i];
      if (s.id === id){ s.style.display=''; s.style.opacity=1; }
      else { s.style.display='none'; s.style.opacity=0; }
    }
    // splash for game tabs
    var splash = $("splash");
    if (GAME_TABS[id]) {
      splash.style.display='flex';
      setTimeout(function(){ splash.style.display='none'; }, 900);
    } else {
      splash.style.display='none';
    }
    if (id!=='driver' && window.RoadRage && RoadRage.pause) RoadRage.pause();

    // save + hash
    try{ localStorage.setItem(LAST_KEY, id); }catch(e){}
    if(location.hash!=="#"+id){ history.replaceState(null,"","#"+id); }
    setActive(id);
  }

  // wire buttons
  for (var j=0;j<buttons.length;j++){
    (function(btn){
      btn.addEventListener('click', function(e){
        e.preventDefault(); clickBeep();
        showTab(btn.getAttribute('data-tab'));
      });
    })(buttons[j]);
  }

  // expose
  window.showTab = showTab;

  // initial state (hide all then show remembered/hash)
  for (var i=0;i<sections.length;i++){
    sections[i].style.display = 'none';
    sections[i].style.opacity = 0;
  }
  var initial = (location.hash||"").replace("#","");
  if(!initial){ try{ initial = localStorage.getItem(LAST_KEY)||"dash"; }catch(e){ initial="dash"; } }
  showTab(initial);

  // respond to hash changes (e.g., links)
  window.addEventListener('hashchange', function(){ var id=(location.hash||"").replace("#",""); showTab(id); });
})();

/* ========= ZA Clock (Africa/Johannesburg) ========= */
(function(){
  function upd(){
    try{
      var d = new Date();
      var s = new Intl.DateTimeFormat('en-ZA',{hour:'2-digit',minute:'2-digit',second:'2-digit',hour12:false,timeZone:'Africa/Johannesburg'}).format(d);
      $("zaClock").textContent = s;
    }catch(e){ $("zaClock").textContent = new Date().toLocaleTimeString(); }
  }
  upd(); setInterval(upd, 1000);
})();

/* ========= Dashboard hero tilt (lightweight) ========= */
(function(){
  var el = $("hero3d"); if(!el) return;
  var rect=null;
  function on(e){
    rect = el.getBoundingClientRect();
    var cx = rect.left + rect.width/2, cy = rect.top + rect.height/2;
    var x = (e.clientX || (e.touches&&e.touches[0].clientX) || cx);
    var y = (e.clientY || (e.touches&&e.touches[0].clientY) || cy);
    var dx = ((x-rect.left)/rect.width - .5), dy = ((y-rect.top)/rect.height - .5);
    var rx = (dy * -6).toFixed(2), ry = (dx * 8).toFixed(2);
    el.style.transform = "perspective(1000px) rotateX("+rx+"deg) rotateY("+ry+"deg)";
  }
  function off(){ el.style.transform="perspective(1000px) rotateX(0deg) rotateY(0deg)"; }
  el.addEventListener("mousemove",on); el.addEventListener("mouseleave",off);
  el.addEventListener("touchmove",on,{passive:true}); el.addEventListener("touchend",off);
})();

/* ========= DASH TILES → OPEN TABS (robust for Android/WebView) ========= */
(function(){
  var box = document.getElementById('dashTiles'); if(!box) return;

  function getTileTarget(el){
    // manual "closest [data-go]" to avoid needing Element.closest()
    while(el && el!==box && !(el.getAttribute && el.getAttribute('data-go'))){ el = el.parentNode; }
    return (el && el.getAttribute && el.getAttribute('data-go')) ? el : null;
  }
  function openTabFromTile(id){
    if (typeof window.showTab === 'function') { window.showTab(id); return; }
    // Fallback (if tabs script didn’t load for some reason)
    var sections = document.querySelectorAll('section');
    for (var i=0;i<sections.length;i++){
      var s = sections[i];
      s.style.display = (s.id===id)? '' : 'none';
      s.style.opacity = (s.id===id)? 1 : 0;
    }
    var btns = document.querySelectorAll('.tab-btn[data-tab]');
    for (var j=0;j<btns.length;j++){
      var b = btns[j];
      if (b.getAttribute('data-tab')===id) b.classList.add('active');
      else b.classList.remove('active');
    }
    try{ history.replaceState(null,"","#"+id); }catch(e){}
  }

  box.addEventListener('click', function(e){
    var t = getTileTarget(e.target); if(!t) return;
    e.preventDefault(); if(typeof clickBeep==="function") clickBeep();
    openTabFromTile(t.getAttribute('data-go'));
  });

  box.addEventListener('keydown', function(e){
    if(e.key!=='Enter' && e.key!==' ') return;
    var t = getTileTarget(e.target); if(!t) return;
    e.preventDefault(); if(typeof clickBeep==="function") clickBeep();
    openTabFromTile(t.getAttribute('data-go'));
  });
})();

/* ========= HANGMAN ========= */
(function(){
  var words=[
    {w:"METAPHOR",h:"A direct comparison without using 'like' or 'as'."},
    {w:"IAMBIC",h:"The basic metrical foot in Shakespeare’s verse."},
    {w:"PENTAMETER",h:"Five feet in a poetic line."},
    {w:"JULIET",h:"She asks: 'Wherefore art thou…'"},
    {w:"ROMEO",h:"He climbs the balcony."},
    {w:"CONFLICT",h:"Opposition between Montagues and Capulets."},
    {w:"HYPERBOLE",h:"Deliberate exaggeration."},
    {w:"CONCH",h:"LOTF: Symbol of order."},
    {w:"GLASSES",h:"Piggy’s object signifying reason."},
    {w:"SUMMER",h:"Season that 'shall not fade'."},
    {w:"TEMPEST",h:"'Rough winds do shake…'."},
    {w:"ALLITERATION",h:"Repetition of initial consonant sounds."},
    {w:"SYMBOLISM",h:"When an object carries a deeper meaning."},
    {w:"TRAGEDY",h:"Genre of Romeo and Juliet."}
  ];
  var cvs=$("hmCanvas"), ctx=cvs.getContext("2d");
  var current=null, lives=6, used=[], revealed=[], won=false, lost=false;

  function drawBase(){
    ctx.clearRect(0,0,cvs.width,cvs.height);
    ctx.strokeStyle="#cfe7ff"; ctx.lineWidth=4;
    ctx.beginPath(); ctx.moveTo(40,270); ctx.lineTo(140,270);
    ctx.moveTo(90,270); ctx.lineTo(90,60); ctx.lineTo(240,60); ctx.lineTo(240,90); ctx.stroke();
    ctx.fillStyle="#cfe7ff"; ctx.font="bold 16px Arial"; ctx.fillText("Mr Samuels - Grade 10 HL Hangman", 12, 24);
  }
  function drawMan(m){
    ctx.strokeStyle="#ff6a00"; ctx.lineWidth=4;
    if(m>0){ ctx.beginPath(); ctx.arc(240,110,20,0,Math.PI*2); ctx.stroke(); }
    if(m>1){ ctx.beginPath(); ctx.moveTo(240,130); ctx.lineTo(240,180); ctx.stroke(); }
    if(m>2){ ctx.beginPath(); ctx.moveTo(240,140); ctx.lineTo(215,165); ctx.stroke(); }
    if(m>3){ ctx.beginPath(); ctx.moveTo(240,140); ctx.lineTo(265,165); ctx.stroke(); }
    if(m>4){ ctx.beginPath(); ctx.moveTo(240,180); ctx.lineTo(220,215); ctx.stroke(); }
    if(m>5){ ctx.beginPath(); ctx.moveTo(240,180); ctx.lineTo(260,215); ctx.stroke(); }
  }
  function pick(){ current = words[Math.floor(Math.random()*words.length)]; lives=6; used=[]; won=false; lost=false;
    revealed = current.w.split(""); for(var i=0;i<revealed.length;i++){ if(revealed[i]!==" ") revealed[i]="_"; } render(); }
  function render(){
    drawBase(); drawMan(6-lives);
    $("hmLives").textContent=lives; $("hmWins").textContent=STATS.hmWins|0;
    $("hmSlots").textContent=revealed.join(" ");
    $("hmUsed").textContent="Used: " + (used.length? used.join(" ") : "—");
    $("hmResult").textContent = won? "✅ Correct! “"+current.w+"”" : (lost? "❌ The word was “"+current.w+"”" : "");
  }
  function guess(ch){
    if(won||lost) return;
    if(used.indexOf(ch)>=0) return;
    used.push(ch);
    var good=false;
    for(var i=0;i<current.w.length;i++){
      if(current.w[i]===ch){ revealed[i]=ch; good=true; }
    }
    if(good){ pop(); confetti(30); if(revealed.join("")===current.w){ won=true; STATS.hmWins=(STATS.hmWins|0)+1; saveObj(STORE_KEY,STATS); refreshDash(); } }
    else{ beep(); lives--; if(lives<=0){ lost=true; crashSound(); } }
    render();
  }
  (function buildKeys(){
    var k=$("hmKeys"); k.innerHTML="";
    var A="ABCDEFGHIJKLMNOPQRSTUVWXYZ".split("");
    for(var i=0;i<A.length;i++){
      (function(ch){
        var b=document.createElement("button"); b.textContent=ch;
        b.onclick=function(){ clickBeep(); guess(ch); b.disabled=true; };
        k.appendChild(b);
      })(A[i]);
    }
  })();
  $("hmHint").onclick=function(){ clickBeep(); $("hmHintBox").style.display="block"; $("hmHintBox").textContent=current?("Hint: "+current.h):"Pick a word."; };
  $("hmNew").onclick=function(){ clickBeep(); pick(); var bs=document.querySelectorAll("#hmKeys button"); for(var i=0;i<bs.length;i++) bs[i].disabled=false; $("hmHintBox").style.display="none"; $("hmResult").textContent=""; };
  $("hmReveal").onclick=function(){ clickBeep(); if(!current)return; revealed=current.w.split(""); lost=true; render(); };
  pick();
})();

/* ========= 30 SECONDS ========= */
(function(){
  var bank=[
    {w:"METAPHOR", d:"Direct comparison without 'like' or 'as'."},
    {w:"IAMBIC", d:"A poetic foot with unstressed–stressed."},
    {w:"PENTAMETER", d:"Five feet per line of verse."},
    {w:"CONCH", d:"LOTF shell symbolising order."},
    {w:"GLASSES", d:"Piggy’s — symbol of reason."},
    {w:"CONFLICT", d:"Opposing forces in a story."},
    {w:"HYPERBOLE", d:"Extreme exaggeration."},
    {w:"ALLITERATION", d:"Repetition of starting consonants."},
    {w:"SYMBOLISM", d:"Objects stand for ideas."},
    {w:"TRAGEDY", d:"Play genre of Romeo & Juliet."}
  ];
  var round=false, time=30, timer=null, current=null, score=0;
  var inp=$("secInput");
  function setHourglass(t){
    var hTop=$("hgTop"), hBot=$("hgBottom"), stream=$("hgStream");
    var frac=(30-t)/30; var topH=60*(1-frac), botH=60*frac;
    hTop.setAttribute("y", 20+(60-topH)); hTop.setAttribute("height", Math.max(0, topH));
    hBot.setAttribute("y", 140-botH); hBot.setAttribute("height", Math.max(0, botH));
    if(t<30 && t>0){ stream.setAttribute("visibility","visible"); stream.setAttribute("height", Math.max(0, 60*(1-Math.abs(15-t)/15))); }
    else{ stream.setAttribute("visibility","hidden"); stream.setAttribute("height", 0); }
    $("secTime").textContent = Math.ceil(t);
  }
  function pick(){ current = bank[Math.floor(Math.random()*bank.length)]; $("secDef").textContent=current.d; inp.value=""; }
  function start(){
    if(round) return; clickBeep();
    score=0; $("secScore").textContent=0; $("secFeedback").textContent=""; $("secLast").textContent="";
    time=30; setHourglass(time); round=true; $("secSkip").disabled=false; $("secGive").disabled=false; pick(); inp.focus();
    var t0=performance.now();
    timer=setInterval(function(){ time-=1; setHourglass(time); if(time<=0){ stop(t0); } },1000);
  }
  function stop(t0){
    clearInterval(timer); round=false; $("secSkip").disabled=true; $("secGive").disabled=true; $("secDef").textContent="Time! Score: "+score;
    var elapsed=(performance.now()-t0)/1000;
    if(score>0){ STATS.secFast = STATS.secFast? Math.min(STATS.secFast, elapsed/score) : (elapsed/score); }
    STATS.secTotal=(STATS.secTotal|0)+score; saveObj(STORE_KEY,STATS); refreshDash();
  }
  function correct(){
    pop(); confetti(30); score++; $("secScore").textContent=score;
    $("secFeedback").textContent="✅ Correct: "+current.w; $("secLast").textContent="+"+current.w.length+" letters";
    pick();
  }
  function give(){ if(!current) return; beep(); $("secFeedback").textContent="ℹ️ Answer: "+current.w; pick(); }
  $("secStart").onclick=start;
  $("secSkip").onclick=function(){ clickBeep(); pick(); };
  $("secGive").onclick=function(){ clickBeep(); give(); };
  inp.addEventListener("input",function(){ if(!round||!current) return; var guess=inp.value.trim().toUpperCase(); if(guess && guess===current.w){ correct(); inp.value=""; }});
  setHourglass(30);
})();

/* ========= MILLIONAIRE ========= */
(function(){
  var ladder=[100,200,300,500,1000,2000,4000,8000,16000,32000,64000,125000,250000,500000,1000000];
  var Q=[
    {c:"Sonnet 18",q:"In Sonnet 18, 'the eye of heaven' refers to the…",o:["Sun","Moon","Heaven","Angel"],a:"Sun"},
    {c:"Sonnet 18",q:"'So long lives this' refers to the poem’s…",o:["Immortality","Meter","Rhyme","Imagery"],a:"Immortality"},
    {c:"Balcony Scene",q:"'Wherefore art thou Romeo?' means…",o:["Why are you Romeo?","Where are you?","Who are you?","Will you come?"],a:"Why are you Romeo?"},
    {c:"Lord of the Flies",q:"Piggy’s glasses stand for…",o:["Reason","Cowardice","Beauty","Fear"],a:"Reason"},
    {c:"Literary Devices",q:"A direct comparison without 'like'/'as' is…",o:["Metaphor","Simile","Allusion","Irony"],a:"Metaphor"},
    {c:"Parts of Speech",q:"'Quickly' is usually a(n)…",o:["Adverb","Adjective","Noun","Preposition"],a:"Adverb"},
    {c:"Poetry Forms",q:"Shakespeare’s sonnets are written in…",o:["Iambic pentameter","Trochaic trimeter","Free verse","Haiku"],a:"Iambic pentameter"}
  ];
  function setTheme(cat){
    var c={"Sonnet 18":"#ff2b2b","Balcony Scene":"#ff9f1c","Lord of the Flies":"#2ec4b6","Literary Devices":"#8a5cff","Parts of Speech":"#00f5d4","Poetry Forms":"#fca311"}[cat]||"#8a5cff";
    document.documentElement.style.setProperty('--theme', c); $("milDot").style.background=c; $("milCat").textContent=cat;
  }
  function drawLadder(step){
    var ul=$("milLadder"); ul.innerHTML="";
    for(var i=ladder.length;i>=1;i--){
      var li=document.createElement("li");
      li.innerHTML="<span>"+i+"</span><b>"+ladder[i-1].toLocaleString()+"</b>";
      if(i===step) li.className="active";
      ul.appendChild(li);
    }
  }
  var step=1, used=[], cur=null, lifeline5050=true, lifelineSkip=true;
  function pick(){ var idx; if(used.length>=Q.length) used=[]; do{ idx=Math.floor(Math.random()*Q.length); }while(used.indexOf(idx)>=0); used.push(idx); return Q[idx]; }
  function show(){ cur = pick(); setTheme(cur.c); $("milQ").textContent = cur.q; var box=$("milOpts"); box.innerHTML=""; var opts=cur.o.slice().sort(function(){return Math.random()-0.5;});
    for(var i=0;i<opts.length;i++){ (function(opt){ var b=document.createElement("button"); b.className="btn secondary"; b.textContent=opt; b.onclick=function(){check(opt)}; box.appendChild(b); })(opts[i]); }
    $("milStep").textContent=step;
  }
  function check(opt){
    STATS.milAnswered=(STATS.milAnswered|0)+1;
    if(opt===cur.a){
      STATS.milCorrect=(STATS.milCorrect|0)+1; pop(); confetti(40); $("milFeedback").textContent="✅ Correct!";
      step++; if(step===8){ addMerits(1); } if(step>15){ addMerits(2); toast("🏆 Millionaire!"); }
      STATS.milBest=Math.max(STATS.milBest|0, Math.min(step-1,15)); saveObj(STORE_KEY,STATS); refreshDash();
      if(step>15){ step=1; drawLadder(step); return; }
      drawLadder(step); show();
    } else {
      beep(); $("milFeedback").textContent="❌ Correct answer: "+cur.a;
      STATS.milBest=Math.max(STATS.milBest|0, Math.min(step-1,15)); saveObj(STORE_KEY,STATS); refreshDash();
      step=1; lifeline5050=true; lifelineSkip=true; $("mil5050").disabled=false; $("milSkip").disabled=false; drawLadder(step); show();
    }
  }
  $("milStart").onclick=function(){ clickBeep(); themeJingle(); step=1; used=[]; $("milFeedback").textContent=""; lifeline5050=true; lifelineSkip=true; $("mil5050").disabled=false; $("milSkip").disabled=false; drawLadder(step); show(); };
  $("milQuit").onclick=function(){ clickBeep(); $("milFeedback").textContent="🏁 Quit. Re-start when ready."; step=1; drawLadder(step); };
  $("mil5050").onclick=function(){ clickBeep(); if(!cur||!lifeline5050)return; lifeline5050=false; $("mil5050").disabled=true; var buttons=$("milOpts").children; var removed=0;
    for(var i=0;i<buttons.length;i++){ var b=buttons[i]; if(b.textContent!==cur.a && removed<2){ b.disabled=true; b.style.opacity=.5; removed++; }}};
  $("milSkip").onclick=function(){ clickBeep(); if(!cur||!lifelineSkip)return; lifelineSkip=false; $("milSkip").disabled=true; $("milFeedback").textContent="⏭️ Skipped."; show(); };
  drawLadder(step);
})();

/* ========= ROAD RAGE ========= */
var RoadRage=(function(){
  var cvs=$("drvCanvas"), ctx=cvs.getContext("2d");
  var DPR=1, W=360, H=540;

  var lanes=5, roadMargin=0.16;
  var STAGE_TIME=30;
  var MAX_SPEED=250, NITRO_MAX=320, NITRO_MIN=260, MIN_SPEED=30;
  var ACCEL_RATE=70, DRAG_RATE=14, BRAKE_RATE=140;
  var OB_CLUSTER_P=0.0036, BOOST_P=0.002, OIL_P=0.0025, AMMO_P=0.0018;

  var VEH_TYPES=[
    {t:"car",  w:34,h:52, color:"#ffffff", vf:1.00},
    {t:"bus",  w:44,h:80, color:"#ffd166", vf:0.90},
    {t:"truck",w:44,h:74, color:"#9ad0ff", vf:0.95},
    {t:"bike", w:24,h:44, color:"#a4ff9a", vf:0.80},
    {t:"super",w:36,h:48, color:"#ff5e57", vf:1.15},
    {t:"moto", w:18,h:36, color:"#ffb3c1", vf:1.10}
  ];
  var STAGES=[
    {name:"Mountainous",road:"#11243f", dash:"#fca311", sky:"#041225"},
    {name:"Farmland",   road:"#0e2a1c", dash:"#b7e07e", sky:"#02150B"},
    {name:"Dirt Road",  road:"#3b2a16", dash:"#e1b382", sky:"#120a04"},
    {name:"City",       road:"#1a1f2c", dash:"#9ad0ff", sky:"#0b0d16"},
    {name:"Suburbs",    road:"#1c2631", dash:"#bcd1ff", sky:"#0c1420"},
    {name:"Ghetto",     road:"#2a1c24", dash:"#ff8aa1", sky:"#12070c"},
    {name:"Futuristic", road:"#101c36", dash:"#00f5d4", sky:"#030b1a"}
  ];

  var laneX=[], dashes=[];
  var running=false, last=0, meters=0, speed=50, score=0;
  var stageIdx=0, stageStartT=0, timeLeft=STAGE_TIME;
  var obstacles=[], boosts=[], oils=[], ammos=[];
  var bullets=[], smokes=[], skid=[], ammoCount=0;
  var lives=3, respawn=false;
  var accelHeld=false, brakeHeld=false, wasBraking=false;

  var player={lane:2,y:0,color:"#12e5ff",visible=true};
  var targetLane=2, laneVel=0;

  var nitro=false, nitroTime=0, nitroPrevSpeed=50;
  var slipTimer=0, slipPhase=0;
  var heroActive=false, heroX=-60, heroY=80, heroAwarded=false;

  var tiltEnabled=false, tiltGamma=0, tiltZero=null;
  function enableTilt(){
    try{
      if(typeof DeviceOrientationEvent!=="undefined"){
        if(DeviceOrientationEvent.requestPermission){
          DeviceOrientationEvent.requestPermission().then(function(s){ if(s==="granted"){window.addEventListener("deviceorientation",onOri,true); tiltEnabled=true;}});
        }else{ window.addEventListener("deviceorientation",onOri,true); tiltEnabled=true; }
      }
    }catch(e){}
  }
  function onOri(e){ if(typeof e.gamma==="number"){ if(tiltZero===null) tiltZero=e.gamma; tiltGamma=e.gamma-tiltZero; } }

  window.addEventListener("keydown",function(e){
    if(e.key==="ArrowLeft"){ e.preventDefault(); left(); }
    if(e.key==="ArrowRight"){ e.preventDefault(); right(); }
    if(e.code==="Space"){ e.preventDefault(); fire(); }
  });

  var engine=null, gear=1;
  var SHIFT_UP=[30,70,120,180], SHIFT_DN=[25,60,100,150];
  function engineStart(){
    try{
      var ac=safeAC(); if(ac.state==="suspended") ac.resume();
      var o1=ac.createOscillator(); o1.type="sawtooth";
      var o2=ac.createOscillator(); o2.type="square";
      var g=ac.createGain(); g.gain.value=0.0;
      var lp=ac.createBiquadFilter(); lp.type="lowpass"; lp.frequency.value=1000;
      o1.connect(lp); o2.connect(lp); lp.connect(g); g.connect(ac.destination);
      o1.start(); o2.start(); engine={o1:o1,o2:o2,g:g,lp:lp}; gear=1;
    }catch(e){ engine=null; }
  }
  function engineStop(){ try{ if(engine){ engine.o1.stop(); engine.o2.stop(); engine.g.disconnect(); engine=null; } }catch(e){} }
  function gearBlip(){ try{ var ac=safeAC(), o=ac.createOscillator(), g=ac.createGain(); o.type="triangle"; o.frequency.value=120; g.gain.value=0.25; o.connect(g); g.connect(ac.destination); o.start(); setTimeout(function(){o.stop();},90);}catch(e){} }
  function engineUpdate(){
    if(!engine||!AC){ updateGauges(); return; }
    if(speed>SHIFT_UP[gear-1] && gear<5){ gear++; gearBlip(); }
    if(gear>1 && speed<SHIFT_DN[gear-2]){ gear--; gearBlip(); }
    var gearRat=[0.38,0.55,0.72,0.88,1.0][gear-1];
    var max = (nitro?NITRO_MAX:MAX_SPEED);
    var rpmPct = Math.min(1, (speed/max)/(gearRat*0.9) );
    var baseF = 80 + 220*rpmPct;
    engine.o1.frequency.setTargetAtTime(baseF, AC.currentTime, 0.05);
    engine.o2.frequency.setTargetAtTime(baseF/2, AC.currentTime, 0.05);
    var targetVol = (running? (0.06 + 0.12*rpmPct) : 0.0);
    engine.g.gain.setTargetAtTime(targetVol, AC.currentTime, 0.05);
    updateGauges();
  }
  function updateGauges(){
    var speedPct = Math.min(100, 100 * speed / (nitro?NITRO_MAX:MAX_SPEED));
    $("speedFill").style.width = speedPct + "%";
    if(nitro){ $("nitroGauge").style.display="block"; $("nitroFill").style.width = (100*nitroTime/7).toFixed(1)+"%"; }
    else{ $("nitroGauge").style.display="none"; }
    $("drvAmmo").textContent = ammoCount;
  }

  function dprScale(){
    var vw=innerWidth, vh=innerHeight;
    var maxH = Math.floor(vh*0.78), cssH = Math.min(660, maxH), cssW = Math.floor(cssH*(2/3));
    cssW = Math.min(cssW, Math.floor(vw*0.94)); cssH = Math.min(cssH, Math.floor(cssW*1.5));
    cvs.style.width=cssW+"px"; cvs.style.height=cssH+"px";
    DPR=devicePixelRatio||1; W=cssW; H=cssH; cvs.width=Math.floor(cssW*DPR); cvs.height=Math.floor(cssH*DPR); ctx.setTransform(DPR,0,0,DPR,0,0);
    var left=W*roadMargin, right=W*(1-roadMargin), inner=right-left; laneX=[]; for(var i=0;i<lanes;i++) laneX.push(left+inner*((i+0.5)/lanes));
    dashes=[]; for(var y=0;y<H;y+=60) dashes.push({y:y});
    player.y=Math.floor(H*0.86);
    draw();
  }
  addEventListener("resize",dprScale); addEventListener("orientationchange",function(){setTimeout(dprScale,200)});

  function rr(x,y,w,h,r){if(r>w/2)r=w/2;if(r>h/2)r=h/2;ctx.beginPath();ctx.moveTo(x+r,y);ctx.lineTo(x+w-r,y);ctx.quadraticCurveTo(x+w,y,x+w,y+r);ctx.lineTo(x+w,y+h-r);ctx.quadraticCurveTo(x+w,y+h,x+w-r,y+h);ctx.lineTo(x+r,y+h);ctx.quadraticCurveTo(x,y+h,x,y+h-r);ctx.lineTo(x,y+r);ctx.quadraticCurveTo(x,y,x+r,y);ctx.closePath();}
  function drawVehicle(cx,cy,vt){var w=vt.w,h=vt.h,x=cx-w/2,y=cy-h/2;ctx.fillStyle=vt.color;ctx.strokeStyle="#233";ctx.lineWidth=2;rr(x,y,w,h,8);ctx.fill();ctx.stroke();ctx.fillStyle="#071018";rr(x+6,y+6,w-12,14,4);ctx.fill();}
  function drawOil(cx,cy){ctx.fillStyle="#111";ctx.beginPath();ctx.ellipse(cx,cy,14,8,0,0,Math.PI*2);ctx.fill();ctx.strokeStyle="#222";ctx.stroke();}
  function drawNitroPickup(cx,cy){ctx.fillStyle="#ff6a00";ctx.beginPath();ctx.arc(cx,cy,12,0,Math.PI*2);ctx.fill();ctx.font="bold 12px Arial";ctx.textAlign="center";ctx.textBaseline="middle";ctx.fillStyle="#061314";ctx.fillText("⚡",cx,cy+1);}
  function drawAmmoPickup(cx,cy){ctx.fillStyle="#ffd166"; rr(cx-12,cy-10,24,20,4); ctx.fill(); ctx.strokeStyle="#332"; ctx.stroke(); ctx.fillStyle="#061314"; ctx.font="16px Arial"; ctx.textAlign="center"; ctx.textBaseline="middle"; ctx.fillText("🔫",cx,cy+1); }
  function drawFlames(cx,cy){
    var t=performance.now()/100; var j=6+Math.sin(t)*2;
    ctx.save(); ctx.globalCompositeOperation="lighter";
    for(var i=-1;i<=1;i++){
      ctx.fillStyle="rgba(255,90,0,.85)"; ctx.beginPath();
      ctx.moveTo(cx+(i*10),cy+30); ctx.lineTo(cx+(i*10)-j,cy+55+j); ctx.lineTo(cx+(i*10)+j,cy+55+j); ctx.closePath(); ctx.fill();
      ctx.fillStyle="rgba(255,200,0,.9)"; ctx.beginPath();
      ctx.moveTo(cx+(i*10),cy+32); ctx.lineTo(cx+(i*10)-j*.6,cy+50+j*.6); ctx.lineTo(cx+(i*10)+j*.6,cy+50+j*.6); ctx.closePath(); ctx.fill();
    }
    ctx.restore();
  }
  function drawSmoke(p){ ctx.save(); ctx.globalAlpha = Math.max(0, p.life/0.5); ctx.fillStyle="rgba(200,200,200,.9)";
    ctx.beginPath(); ctx.arc(p.x, p.y, 10+5*(1-p.life/0.5), 0, Math.PI*2); ctx.fill(); ctx.restore(); }
  function drawHero(){
    ctx.save(); ctx.translate(heroX,heroY);
    ctx.fillStyle="#d61e1e"; ctx.beginPath(); ctx.ellipse(0,-18,10,12,0,0,Math.PI*2); ctx.fill();
    ctx.fillStyle="#e5b200"; rr(-12, -6, 24, 20, 6); ctx.fill();
    ctx.fillStyle="#d61e1e"; rr(-18, -6, 8, 22, 4); rr(10, -6, 8, 22, 4); ctx.fill();
    ctx.fillStyle="#e5b200"; rr(-10, 14, 8, 16, 4); rr(2, 14, 8, 16, 4); ctx.fill();
    ctx.restore();
  }
  function drawPlayerCar(cx,cy){
    var bodyW=36, bodyH=56, x=cx-bodyW/2, y=cy-bodyH/2;
    ctx.fillStyle="#0b0b0b"; var tw=8, th=14;
    rr(x-6, y+6, tw, th, 3); ctx.fill();
    rr(x+bodyW-2, y+6, tw, th, 3); ctx.fill();
    rr(x-6, y+bodyH-th-6, tw, th, 3); ctx.fill();
    rr(x+bodyW-2, y+bodyH-th-6, tw, th, 3); ctx.fill();
    ctx.fillStyle="#12e5ff"; ctx.strokeStyle="#244"; ctx.lineWidth=2; rr(x,y,bodyW,bodyH,10); ctx.fill(); ctx.stroke();
    ctx.fillStyle="#071018"; rr(x+6,y+6,bodyW-12,16,6); ctx.fill();
    ctx.fillStyle="#00f5d4"; rr(cx-3,y+22,6,bodyH-30,3); ctx.fill();
  }

  function stageTheme(){return STAGES[stageIdx%STAGES.length];}
  function draw(){
    var th=stageTheme(); ctx.save();
    if(nitro){ var m=2 + Math.max(0, speed-MAX_SPEED)/10; ctx.translate((Math.random()-0.5)*m, (Math.random()-0.5)*m); }
    ctx.fillStyle=th.sky; ctx.fillRect(0,0,W,H);
    var left=W*roadMargin, right=W*(1-roadMargin);
    ctx.fillStyle=th.road; ctx.fillRect(left,0,right-left,H);
    ctx.strokeStyle="#cfe7ff"; ctx.setLineDash([12,12]); ctx.lineWidth=2;
    for(var i=1;i<lanes;i++){var x=left+(right-left)*i/lanes; ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,H); ctx.stroke();}
    ctx.setLineDash([]);
    ctx.strokeStyle=th.dash; ctx.lineWidth=6;
    for(var i=0;i<dashes.length;i++){ctx.beginPath(); ctx.moveTo(left+20,dashes[i].y); ctx.lineTo(right-20,dashes[i].y); ctx.stroke();}

    for(var s=0;s<skid.length;s++){ var sk=skid[s]; ctx.save(); ctx.globalAlpha=sk.a; ctx.strokeStyle="#111"; ctx.lineWidth=3; ctx.beginPath(); ctx.moveTo(sk.x1,sk.y1); ctx.lineTo(sk.x2,sk.y2); ctx.stroke(); ctx.restore(); }

    for(var i1=0;i1<oils.length;i1++) drawOil(laneX[oils[i1].lane],oils[i1].y);
    for(var i2=0;i2<boosts.length;i2++) drawNitroPickup(laneX[boosts[i2].lane],boosts[i2].y);
    for(var i3=0;i3<ammos.length;i3++) drawAmmoPickup(laneX[ammos[i3].lane],ammos[i3].y);
    for(var i4=0;i4<obstacles.length;i4++){var ob=obstacles[i4]; drawVehicle(laneX[ob.lane],ob.y,ob.vt);}
    ctx.fillStyle="#fffb"; for(var b=0;b<bullets.length;b++){ var bl=bullets[b]; ctx.fillRect(bl.x-2, bl.y-10, 4, 10); }
    for(var sm=0;sm<smokes.length;sm++) drawSmoke(smokes[sm]);

    if(heroActive) drawHero();

    var step=(laneX[1]-laneX[0]), px=laneX[0]+step*player.lane;
    if(player.visible){ if(nitro) drawFlames(px,player.y); drawPlayerCar(px,player.y); }
    ctx.restore();
  }

  function startStage(idx){ stageIdx=idx%STAGES.length; $("drvStageName").textContent=STAGES[stageIdx].name; stageStartT=performance.now(); timeLeft=STAGE_TIME; heroActive=false; heroAwarded=false; }
  function nextStageQuiz(){
    running=false; engineStop();
    if(!heroAwarded){ score+=500; $("drvScore").textContent=score; toast("🦾 Hero bonus +500"); heroAwarded=true; }
    askStageQuestions(3, function(){ stageIdx=(stageIdx+1)%STAGES.length; startStage(stageIdx); run(); });
  }
  function askStageQuestions(n,done){
    var overlay=$("drvOverlay"); overlay.style.display="flex";
    var asked=0, pts=0;
    function askOne(){
      if(asked>=n){ overlay.style.display="none"; toast("✅ Stage complete! +" + pts + " pts"); if(done) done(); return; }
      var q=pickMCQ();
      $("drvQ").innerHTML="<div class='pill' style='margin-bottom:6px'>"+q.cat+"</div>"+q.q;
      var box=$("drvOpts"); box.innerHTML="";
      var opts=q.options.slice().sort(function(){return Math.random()-0.5;});
      for(var i=0;i<opts.length;i++){
        (function(opt){
          var b=document.createElement("button"); b.className="btn secondary"; b.textContent=opt;
          b.onclick=function(){ if(opt===q.correct){ pts+=150; $("drvScore").textContent=(score+=150); askNext(); } else { toast("Answer: "+q.correct); askNext(); } };
          box.appendChild(b);
        })(opts[i]);
      }
      function askNext(){ asked++; askOne(); }
    }
    askOne();
  }
  var MCQ=[{cat:"Sonnet 18",q:"'Eye of heaven' refers to the…",options:["Sun","Moon","Stars","Wind"],correct:"Sun"},
           {cat:"Balcony Scene",q:"'Wherefore art thou Romeo?' means…",options:["Why are you Romeo?","Where are you?","Who are you?","When will you come?"],correct:"Why are you Romeo?"},
           {cat:"Lord of the Flies",q:"The conch symbolises…",options:["Order","Wealth","Romance","Magic"],correct:"Order"}];
  function pickMCQ(){return MCQ[Math.floor(Math.random()*MCQ.length)];}

  function startNitro(){ if(!nitro){ nitroPrevSpeed=speed; } nitro=true; nitroTime=7.0; if(speed<NITRO_MIN) speed=NITRO_MIN; $("nitroGauge").style.display="block"; }
  function fire(){ if(!running || ammoCount<=0) return; var step=(laneX[1]-laneX[0]), px=laneX[0]+step*player.lane; bullets.push({x:px, y:player.y-30, vy:-520}); ammoCount--; updateGauges(); fireSound(); }

  function update(ts){
    if(!running){ last=ts; engineUpdate(); return; }
    var dt=(ts-last)/1000; last=ts;

    timeLeft = Math.max(0, STAGE_TIME - (ts - stageStartT)/1000); $("drvTime").textContent=Math.ceil(timeLeft);
    if(timeLeft<=5 && !heroActive){ heroActive=true; heroX=-60; heroY=80; }
    if(timeLeft<=0){ nextStageQuiz(); return; }

    if(tiltEnabled){ var t = 2 + Math.max(-2, Math.min(2, (tiltGamma/15))); targetLane = Math.max(0, Math.min(lanes-1, t)); }

    var cap = nitro ? NITRO_MAX : MAX_SPEED;
    if(accelHeld)       speed = Math.min(cap, speed + ACCEL_RATE*dt);
    else if(brakeHeld)  speed = Math.max(MIN_SPEED, speed - BRAKE_RATE*dt);
    else                speed = Math.max(MIN_SPEED, speed - DRAG_RATE*dt);

    if(brakeHeld && !wasBraking && speed>90){ screech(); }
    wasBraking = brakeHeld;

    if(nitro){ nitroTime -= dt; if(nitroTime<=0){ nitro=false; $("nitroGauge").style.display="none"; } }
    else if(speed>nitroPrevSpeed){ speed = Math.max(nitroPrevSpeed, speed - (DRAG_RATE*2)*dt); }

    if(slipTimer>0){ slipTimer -= dt; slipPhase += dt*6.5; laneVel += Math.sin(slipPhase)*0.35; }

    var a = 12*(targetLane - player.lane) - 7*laneVel; laneVel += a*dt; player.lane += laneVel*dt;
    if(player.lane<0){player.lane=0; laneVel=0;} if(player.lane>lanes-1){player.lane=lanes-1; laneVel=0;}

    var pxPerSec = (H/2.6) * (speed/50);
    for(var i=0;i<dashes.length;i++){ dashes[i].y+=pxPerSec*dt; if(dashes[i].y>H) dashes[i].y-=H; }
    meters += speed*dt; $("drvDist").textContent=Math.floor(meters); $("drvSpeed").textContent=Math.floor(speed);

    if(brakeHeld && speed>80 && player.visible){
      var stepL=(laneX[1]-laneX[0]), px=laneX[0]+stepL*player.lane;
      skid.push({x1:px-12, y1:player.y+20, x2:px-12, y2:player.y+24, a:.32});
      skid.push({x1:px+12, y1:player.y+20, x2:px+12, y2:player.y+24, a:.32});
    }

    if(Math.random()<OB_CLUSTER_P){
      var y0=-40, free=[0,1,2,3,4], count=1+Math.floor(Math.random()*3); if(count>=lanes) count=lanes-1;
      for(var c=0;c<count;c++){ var li = free.splice(Math.floor(Math.random()*free.length),1)[0]; var vt=VEH_TYPES[Math.floor(Math.random()*VEH_TYPES.length)];
        obstacles.push({lane:li,y:y0,vt:vt, vf:vt.vf}); }
    }
    if(Math.random()<BOOST_P){ boosts.push({lane:Math.floor(Math.random()*lanes), y:-40}); }
    if(Math.random()<OIL_P){ oils.push({lane:Math.floor(Math.random()*lanes), y:-30}); }
    if(Math.random()<AMMO_P){ ammos.push({lane:Math.floor(Math.random()*lanes), y:-40}); }

    for(var i1=obstacles.length-1;i1>=0;i1--){ var ob=obstacles[i1]; ob.y += pxPerSec*dt*ob.vf; if(ob.y>H+80) obstacles.splice(i1,1); }
    for(var i2=boosts.length-1;i2>=0;i2--){ boosts[i2].y += pxPerSec*dt; if(boosts[i2].y>H+40) boosts.splice(i2,1); }
    for(var i3=oils.length-1;i3>=0;i3--){ oils[i3].y += pxPerSec*dt; if(oils[i3].y>H+40) oils.splice(i3,1); }
    for(var i4=ammos.length-1;i4>=0;i4--){ ammos[i4].y += pxPerSec*dt; if(ammos[i4].y>H+40) ammos.splice(i4,1); }
    for(var b=bullets.length-1;b>=0;b--){ var bb=bullets[b]; bb.y += bb.vy*dt; if(bb.y<-20) bullets.splice(b,1); }

    for(var s=skid.length-1;s>=0;s--){ skid[s].y1+=pxPerSec*dt; skid[s].y2+=pxPerSec*dt; skid[s].a -= dt*.8; if(skid[s].y1>H+30 || skid[s].a<=0) skid.splice(s,1); }
    for(var sm=smokes.length-1;sm>=0;sm--){ smokes[sm].y += -20*dt; smokes[sm].life -= dt; if(smokes[sm].life<=0) smokes.splice(sm,1); }

    var stepLane=(laneX[1]-laneX[0]), px=laneX[0]+stepLane*player.lane; var XTH=24, YTH=40;
    if(!respawn){
      for(var i=obstacles.length-1;i>=0;i--){ var ob2=obstacles[i]; if(Math.abs(laneX[ob2.lane]-px)<(ob2.vt.w/2+XTH) && Math.abs(ob2.y-player.y)<(ob2.vt.h/2+YTH)){ obstacles.splice(i,1); crash(); break; } }
      for(var iA=obstacles.length-1;iA>=0;iA--){
        var oo=obstacles[iA], ox=laneX[oo.lane], oy=oo.y, w=oo.vt.w/2+6, h=oo.vt.h/2+6;
        for(var j=bullets.length-1;j>=0;j--){ var bt=bullets[j]; if(Math.abs(ox-bt.x)<w && Math.abs(oy-bt.y)<h){ obstacles.splice(iA,1); bullets.splice(j,1); smokes.push({x:ox,y:oy,life:0.5}); hitSound(); score+=120; $("drvScore").textContent=score; break; } }
      }
      for(var iN=boosts.length-1;iN>=0;iN--){ var nb=boosts[iN]; if(Math.abs(laneX[nb.lane]-px)<XTH && Math.abs(nb.y-player.y)<YTH){ boosts.splice(iN,1); startNitro(); toast("🔥 NITRO!"); } }
      for(var iO=oils.length-1;iO>=0;iO--){ var ooil=oils[iO]; if(Math.abs(laneX[ooil.lane]-px)<XTH && Math.abs(ooil.y-player.y)<YTH){ oils.splice(iO,1); slipTimer=1.5; slipPhase=0; toast("🛢️ Oil!"); } }
      for(var iM=ammos.length-1;iM>=0;iM--){ var am=ammos[iM]; if(Math.abs(laneX[am.lane]-px)<XTH && Math.abs(am.y-player.y)<YTH){ ammos.splice(iM,1); ammoCount+=6; updateGauges(); toast("🔫 Ammo +6"); } }
    }

    engineUpdate();
    draw(); requestAnimationFrame(update);
  }

  function crash(){
    lives--; $("drvLives").textContent=lives; player.visible=false; respawn=true; engineStop(); crashSound();
    if(lives<=0){ gameOver(); return; }
    setTimeout(function(){ player.visible=true; respawn=false; ignitionSound(); engineStart(); }, 900);
  }
  function gameOver(){
    running=false; $("drvGameOver").style.display="flex"; engineStop();
    STATS.drvBest=Math.max(STATS.drvBest|0, Math.floor(meters)); saveObj(STORE_KEY,STATS); refreshDash();
  }

  function left(){ targetLane=Math.max(0, Math.round(targetLane-1)); }
  function right(){ targetLane=Math.min(lanes-1, Math.round(targetLane+1)); }

  function bindPress(el, onDown, onUp){
    function down(e){ e.preventDefault(); if(el.setPointerCapture&&e.pointerId!=null) el.setPointerCapture(e.pointerId); if(onDown) onDown(); }
    function up(){ if(onUp) onUp(); }
    if(window.PointerEvent){
      el.addEventListener("pointerdown",down,false);
      el.addEventListener("pointerup",up,false); el.addEventListener("pointercancel",up,false); el.addEventListener("lostpointercapture",up,false);
    }else{
      el.addEventListener("touchstart",down,{passive:false}); el.addEventListener("touchend",up,false);
      el.addEventListener("mousedown",down,false); el.addEventListener("mouseup",up,false);
    }
    el.addEventListener("click",function(e){ e.preventDefault(); },false);
  }
  bindPress($("pedalAccel"), function(){ accelHeld=true; }, function(){ accelHeld=false; });
  bindPress($("pedalBrake"), function(){ brakeHeld=true; }, function(){ brakeHeld=false; });
  var leftTid=null,rightTid=null;
  bindPress($("btnLeft"), function(){ left(); leftTid=setInterval(left,110); }, function(){ clearInterval(leftTid); });
  bindPress($("btnRight"), function(){ right(); rightTid=setInterval(right,110); }, function(){ clearInterval(rightTid); });
  bindPress($("btnFire"), function(){ fire(); }, null);

  var sx=null; cvs.addEventListener("touchstart",function(e){ sx=e.touches[0].clientX; },{passive:true});
  cvs.addEventListener("touchend",function(e){ if(sx===null) return; var dx=e.changedTouches[0].clientX-sx; if(dx<-20) left(); else if(dx>20) right(); sx=null; },false);

  $("drvStart").onclick=function(){ clickBeep(); reset(); enableTilt(); startStage(0); run(); };
  $("drvPause").onclick=function(){ clickBeep(); running=false; engineStop(); };
  window.addEventListener("blur",function(){ running=false; engineStop(); });

  function run(){ $("drvGameOver").style.display="none"; running=true; last=performance.now(); engineStart(); requestAnimationFrame(update); }
  function reset(){
    meters=0; score=0; $("drvScore").textContent=0; $("drvDist").textContent=0; $("drvLives").textContent=(lives=3);
    obstacles=[]; boosts=[]; oils=[]; ammos=[]; bullets=[]; smokes=[]; skid=[]; ammoCount=0; updateGauges();
    player.lane=2; targetLane=2; laneVel=0; speed=50; nitro=false; nitroTime=0; $("nitroGauge").style.display="none";
    accelHeld=false; brakeHeld=false; wasBraking=false; tiltZero=null; $("drvTime").textContent=STAGE_TIME; $("drvStageName").textContent="—";
    $("drvGameOver").style.display="none"; heroActive=false; heroAwarded=false; dprScale(); draw(); engineStop(); updateGauges();
  }

  dprScale(); reset();
  return {pause:function(){ running=false; engineStop(); }};
})();

/* ========= STUDY subtabs ========= */
(function(){
  var buttons = document.querySelectorAll('.sub-btn');
  var ids = ['studyVocab','lotf','shakespeare'];
  function show(id){ for (var i=0;i<ids.length;i++){ var el=document.getElementById(ids[i]); el.style.display=(ids[i]===id)?'':'none'; } }
  // init to Shakespeare by default
  show('shakespeare');
  for (var i=0;i<buttons.length;i++){
    (function(b){
      b.addEventListener('click', function(){
        for (var j=0;j<buttons.length;j++) buttons[j].classList.remove('active');
        b.classList.add('active'); show(b.getAttribute('data-sub'));
      });
    })(buttons[i]);
  }
})();

/* ========= Student toggle ========= */
(function(){
  var btn=$("btnStudent"), badge=$("studentBadge");
  if(btn){ btn.onclick=function(){ clickBeep(); if(badge.textContent==="Guest Mode"){ badge.textContent="Student Mode"; badge.classList.add("on"); toast("Student mode set"); } else { badge.textContent="Guest Mode"; badge.classList.remove("on"); toast("Guest mode set"); } }; }
})();
</script>
</body>
</html>
