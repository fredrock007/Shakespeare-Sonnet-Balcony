<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta http-equiv="Cache-Control" content="no-store, max-age=0">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Mr Samuels’ Grade 10 English Hub</title>
<style>
  :root{
    --bg:#040713; --panel:rgba(8,14,34,.72); --text:#e7f2ff; --muted:#a8bfdd;
    --accent:#00f5d4; --accent2:#ff5e57; --accent3:#8a5cff; --accent4:#fca311;
    --good:#2ecc71; --bad:#ff4d6d; --theme:#8a5cff;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;color:var(--text);font-family:Inter,system-ui,Segoe UI,Roboto,Arial;background:#000}

  /* Futuristic shell */
  .bg3d{position:fixed; inset:0; z-index:-2; overflow:hidden; perspective:1200px;
    background:radial-gradient(1200px 600px at 10% -10%, #102153 0, #0c1736 35%, #070b1a 65%, #040713 100%), #040713;}
  .bg3d::before{content:""; position:absolute; inset:-20vh -20vw; z-index:-2;
    background:repeating-linear-gradient(to right, rgba(0,245,212,.08) 0 1px, transparent 1px 60px),
               repeating-linear-gradient(to bottom, rgba(138,92,255,.07) 0 1px, transparent 1px 60px);
    transform:rotateX(60deg) translateZ(-200px) translateY(15vh); filter:drop-shadow(0 0 18px rgba(0,245,212,.15));}
  .stars{position:absolute; inset:0; z-index:-1; pointer-events:none;
    background:radial-gradient(2px 2px at 20% 30%, rgba(255,255,255,.28), transparent 40%),
               radial-gradient(2px 2px at 70% 60%, rgba(255,255,255,.18), transparent 40%),
               radial-gradient(2px 2px at 40% 80%, rgba(255,255,255,.20), transparent 40%);
    animation: twinkle 6s linear infinite alternate;}
  @keyframes twinkle{to{filter:brightness(1.3)}}

  .wrap{max-width:1220px;margin:0 auto;padding:18px}
  header{position:relative; display:flex; align-items:center; gap:12px; margin-bottom:16px;
    transform:perspective(1200px) rotateX(.6deg);}
  .holo{position:absolute; inset:-14px -14px auto -14px; height:76px; z-index:-1;
    background:linear-gradient(90deg, rgba(0,245,212,.14), rgba(138,92,255,.14) 40%, rgba(255,94,87,.14) 80%);
    border:1px solid rgba(255,255,255,.14); border-radius:16px; box-shadow: inset 0 0 40px rgba(0,245,212,.08), inset 0 0 60px rgba(138,92,255,.08), 0 10px 40px rgba(0,0,0,.45);}
  .brand{font-weight:900;font-size:24px; letter-spacing:.2px}
  .neon{background:linear-gradient(90deg,var(--accent),var(--accent3));-webkit-background-clip:text;background-clip:text;color:transparent; text-shadow:0 0 12px rgba(0,245,212,.25)}
  .badge{background:linear-gradient(90deg,var(--accent3),var(--accent2));padding:6px 10px;border-radius:999px;font-size:12px;border:1px solid rgba(255,255,255,.18); box-shadow:0 8px 26px rgba(138,92,255,.25)}
  .tabs{margin-left:auto;display:flex;flex-wrap:wrap;gap:10px}
  .tab-btn{border:1px solid rgba(255,255,255,.12); padding:10px 14px; border-radius:14px;background:linear-gradient(180deg,#121a38,#0d1430);color:#e7f2ff; cursor:pointer; font-weight:700; box-shadow:0 12px 0 rgba(0,0,0,.25), 0 10px 30px rgba(0,0,0,.35)}
  .tab-btn.active{color:#061314; background:linear-gradient(180deg,var(--accent) 0,var(--accent3) 100%); box-shadow: 0 12px 0 rgba(0,0,0,.25), 0 0 40px rgba(0,245,212,.35)}
  .ghost{background:transparent;border:1px solid rgba(255,255,255,.2)}

  .card{position:relative; background:var(--panel); border:1px solid rgba(255,255,255,.08); border-radius:20px; padding:16px;
    box-shadow: inset 0 1px 0 rgba(255,255,255,.05), 0 18px 36px rgba(0,0,0,.45), 0 0 60px rgba(138,92,255,.06);}
  .flex{display:flex;gap:16px;flex-wrap:wrap}.row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}.grow{flex:1 1 360px}
  .muted{color:var(--muted)} .big{font-size:18px}
  .grid-2{display:grid;grid-template-columns:1.2fr 1fr;gap:16px}
  @media (max-width:980px){.grid-2{grid-template-columns:1fr}}
  .statgrid{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
  @media (max-width:900px){.statgrid{grid-template-columns:repeat(2,1fr)}}
  .stat{background:linear-gradient(180deg,#101837,#0c1330);border:1px solid rgba(255,255,255,.12);border-radius:16px;padding:12px}
  .stat h4{margin:0 0 6px 0;font-size:12px;color:#bcd1ff}.stat .v{font-size:24px;font-weight:900}
  .pill{display:inline-block;padding:6px 10px;border-radius:999px;background:#101a34;border:1px solid rgba(255,255,255,.12);color:#a8bfdd;font-size:12px}
  .btn{border:0;padding:10px 14px;border-radius:12px;cursor:pointer;font-weight:800;color:#061314;background:linear-gradient(180deg,var(--accent) 0,var(--accent3) 100%);box-shadow:0 10px 26px rgba(138,92,255,.28)}
  .btn.secondary{color:#cfe7ff;background:linear-gradient(180deg,#1b2546 0,#121c3a 100%);border:1px solid rgba(255,255,255,.12)}
  .btn.warn{color:#130a00;background:linear-gradient(180deg,#ffd166 0,var(--accent4) 100%)}
  .btn:disabled{opacity:.6;cursor:not-allowed}

  canvas{background:linear-gradient(180deg,#0c1228,#0a0f21);border:1px solid rgba(255,255,255,.12);border-radius:16px;max-width:100%}
  .slots{letter-spacing:.28em;font-size:26px;margin:10px 0 6px}
  .kbd{display:grid;grid-template-columns:repeat(10,1fr);gap:6px;margin-top:12px}
  .key{background:linear-gradient(180deg,#131e41,#101936);border:1px solid rgba(255,255,255,.12);border-radius:10px;padding:10px 0;text-align:center;font-weight:700;cursor:pointer;color:#cfe7ff}

  input[type="text"]{width:100%;padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:linear-gradient(180deg,#0c1530,#0a1126);color:#e6eef5;font-size:16px}
  .def-box{font-size:18px;line-height:1.45}.hourglass{width:58px;height:90px}.sr-only{position:absolute!important;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0)}

  #million{border:1px solid rgba(255,255,255,.12); border-radius:18px; background:linear-gradient(180deg,#0f1836,#0b1230)}
  #million.theming{box-shadow:0 0 0 3px var(--theme) inset, 0 0 32px var(--theme)}
  .mil-cat{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.18);background:linear-gradient(180deg,#0f1837,#0b1230)}
  .mil-dot{width:10px;height:10px;border-radius:50%}
  .ladder{list-style:none;padding:0;margin:0;display:flex;flex-direction:column-reverse;gap:6px}
  .ladder li{padding:8px 10px;border:1px solid rgba(255,255,255,.14);border-radius:12px;background:linear-gradient(180deg,#0f1836,#0b1230);font-weight:700;display:flex;justify-content:space-between}
  .ladder li.active{background:linear-gradient(90deg,rgba(0,245,212,.35),rgba(138,92,255,.35));border-color:var(--accent)}
  .opt{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px}
  .opt button{padding:12px;border-radius:12px;border:2px solid rgba(255,255,255,.14);background:linear-gradient(180deg,#10193a,#0d1633);color:#e6eef5;font-weight:800;cursor:pointer}

  /* ROAD RAGE */
  .driver-wrap{display:grid;grid-template-columns:1fr;gap:10px}
  .hud{display:flex;gap:10px;flex-wrap:wrap;justify-content:center}
  .overlayQ{position:absolute;inset:0;background:rgba(7,11,26,.8);display:none;align-items:center;justify-content:center;z-index:50}
  .overlayCard{max-width:620px;background:linear-gradient(180deg,#0f1837,#0b1230);border:2px solid var(--theme);border-radius:16px;padding:16px}
  .overlayCard .opt{grid-template-columns:1fr}
  .gameOver{position:absolute;inset:0;display:none;align-items:center;justify-content:center;background:rgba(5,0,0,.65);z-index:60;color:#ff1e1e;font-weight:900;font-size:44px;text-shadow:0 0 22px #300}
  .driver-controls{display:flex;gap:10px;justify-content:space-between}
  .pedal{flex:1;min-width:140px;height:140px;border-radius:18px;border:2px solid rgba(255,255,255,.14);
    background:linear-gradient(180deg,#0d1736,#0b1230);color:#e7f2ff;font-size:20px;font-weight:900;touch-action:none;box-shadow:0 12px 24px rgba(0,0,0,.45)}
  .pedal:active{transform:scale(.98)}
  @media (max-width:600px){.pedal{min-width:120px;height:120px;font-size:18px}}

  /* Study */
  .subtabs{display:flex;gap:8px;margin-bottom:10px}
  .sub-btn{border:1px solid rgba(255,255,255,.12);padding:8px 12px;border-radius:999px;background:linear-gradient(180deg,#121a38,#0d1430);color:#cfe7ff;cursor:pointer}
  table{width:100%;border-collapse:collapse}
  th,td{border:1px solid rgba(255,255,255,.12);padding:8px;vertical-align:top}
  th{background:linear-gradient(180deg,#0f1837,#0b1230)}

  .toast{position:fixed;left:50%;bottom:24px;transform:translateX(-50%);background:#0d1640;border:1px solid rgba(255,255,255,.14);color:#dff3ff;padding:10px 14px;border-radius:999px;opacity:0;transition:opacity .2s, transform .2s;pointer-events:none;z-index:150}
  .toast.show{opacity:1;transform:translateX(-50%) translateY(-6px)}
  .confetti-piece{position:fixed;top:0;left:0;width:8px;height:14px;opacity:.9;pointer-events:none;border-radius:2px}

  section{opacity:1; transition:opacity .28s ease;}
  /* Splash */
  .splash{position:fixed; inset:0; display:none; align-items:center; justify-content:center;
    background:linear-gradient(180deg,rgba(5,8,20,.72),rgba(4,7,19,.82)); backdrop-filter: blur(4px); z-index:200;}
  .logo3d{position:relative; padding:24px 28px; border-radius:22px; transform:perspective(1000px) rotateX(10deg);
    background:radial-gradient(120px 80px at 50% 0%, rgba(255,70,70,.18), transparent 60%); box-shadow: inset 0 0 40px rgba(255,80,60,.18), 0 30px 60px rgba(0,0,0,.6)}
  .logo3d h1{margin:0; font-size: clamp(22px, 6vw, 46px); letter-spacing: 2px; font-weight: 1000; text-transform: uppercase;
    background:linear-gradient(180deg,#ff2b2b,#ff6a00 60%, #ffd166 95%); -webkit-background-clip:text;background-clip:text;color:transparent;
    text-shadow:0 0 12px rgba(255,40,40,.5),0 0 30px rgba(255,90,0,.35),0 8px 18px rgba(0,0,0,.6); animation:pulseGlow .9s ease-in-out 0s 3}
  .emoji-cloud{position:absolute; inset:-22px -26px; pointer-events:none; filter:drop-shadow(0 8px 12px rgba(0,0,0,.45))}
  .emoji{position:absolute; font-size:clamp(18px,4vw,32px)} .e1{top:-10px;left:-6px; transform:rotate(-12deg)} .e2{top:-8px;right:-8px; transform:rotate(12deg)} .e3{bottom:-8px;left:-10px; transform:rotate(8deg)} .e4{bottom:-12px;right:-6px; transform:rotate(-6deg)}
  @keyframes pulseGlow{0%{transform:scale(1)}50%{transform:scale(1.06)}100%{transform:scale(1)}}
</style>
</head>
<body>
<div class="bg3d"><div class="stars"></div></div>

<!-- Splash -->
<div id="splash" class="splash" aria-hidden="true">
  <div class="logo3d">
    <div class="emoji-cloud"><div class="emoji e1">📚</div><div class="emoji e2">📚</div><div class="emoji e3">📚</div><div class="emoji e4">📚</div></div>
    <h1>MR SAMUELS ENGLISH HL</h1>
  </div>
</div>

<div class="wrap">
  <div class="holo"></div>
  <header>
    <div class="brand">Mr Samuels’ <span class="neon">Grade 10 English Hub</span></div>
    <span id="studentBadge" class="badge">Guest Mode</span>
    <button id="btnStudent" class="tab-btn ghost">Set Student</button>
    <div class="tabs">
      <button class="tab-btn active" data-tab="dash">Dashboard</button>
      <button class="tab-btn" data-tab="hangman">Hangman</button>
      <button class="tab-btn" data-tab="seconds">30 Seconds</button>
      <button class="tab-btn" data-tab="million">Millionaire</button>
      <button class="tab-btn" data-tab="driver">Road Rage</button>
      <button class="tab-btn" data-tab="study">Study</button>
    </div>
  </header>

  <!-- DASHBOARD -->
  <section id="dash" class="card">
    <div class="statgrid">
      <div class="stat"><h4>Merits</h4><div class="v" id="s_merits">0</div></div>
      <div class="stat"><h4>Hangman Wins</h4><div class="v" id="s_hm_wins">0</div></div>
      <div class="stat"><h4>30 Seconds — Fastest</h4><div class="v" id="s_30_fast">—</div></div>
      <div class="stat"><h4>30 Seconds — Correct</h4><div class="v" id="s_30_total">0</div></div>
      <div class="stat"><h4>Millionaire — Best Step</h4><div class="v" id="s_mil_best">0 / 15</div></div>
      <div class="stat"><h4>Millionaire — Correct</h4><div class="v" id="s_mil_correct">0</div></div>
      <div class="stat"><h4>Millionaire — Answered</h4><div class="v" id="s_mil_answered">0</div></div>
      <div class="stat"><h4>Road Rage — Best Run</h4><div class="v" id="s_drv_best">0 m</div></div>
    </div>
  </section>

  <!-- HANGMAN -->
  <section id="hangman" class="card" style="display:none">
    <div class="flex">
      <div class="grow" style="max-width:480px">
        <h2>Mr Samuels – Grade 10 HL Hangman</h2>
        <canvas id="hmCanvas" width="430" height="280"></canvas>
      </div>
      <div class="grow">
        <div class="row">
          <span class="pill">Lives: <span id="lives">6</span></span>
          <span class="pill">Wins: <span id="wins">0</span></span>
        </div>
        <div id="slots" class="slots">_ _ _ _ _</div>
        <div id="used" class="muted">Used: —</div>
        <div class="row" style="margin-top:8px">
          <button id="btnHint" class="btn secondary">Show Hint</button>
          <button id="btnNew" class="btn">New Word</button>
          <button id="btnReveal" class="btn warn">Reveal</button>
        </div>
        <div id="hint" class="hint" style="margin-top:10px;display:none"></div>
        <div id="result" class="big" style="margin-top:8px"></div>
        <div class="kbd" id="keyboard" style="margin-top:10px"></div>
      </div>
    </div>
  </section>

  <!-- 30 SECONDS -->
  <section id="seconds" class="card" style="display:none">
    <div class="row" style="justify-content:space-between;align-items:center">
      <div class="pill">Round Score: <span id="secScore">0</span></div>
      <div class="row" style="gap:10px;align-items:center">
        <svg id="hourglass" viewBox="0 0 100 160" class="hourglass" aria-label="Timer">
          <defs><clipPath id="clipTop"><polygon points="20,20 80,20 50,80"/></clipPath>
                 <clipPath id="clipBottom"><polygon points="20,140 80,140 50,80"/></clipPath></defs>
          <rect id="hgTop" x="20" y="20" width="60" height="60" fill="#fca311" clip-path="url(#clipTop)"/>
          <rect id="hgBottom" x="20" y="140" width="60" height="0" fill="#fca311" clip-path="url(#clipBottom)"/>
          <rect id="hgStream" x="48.5" y="78" width="3" height="0" fill="#fca311" visibility="hidden"/>
          <polygon points="20,20 80,20 50,80 20,140 80,140 50,80" fill="none" stroke="#cfe7ff" stroke-width="4"/>
          <rect x="15" y="10" width="70" height="8" fill="#cfe7ff"/><rect x="15" y="142" width="70" height="8" fill="#cfe7ff"/>
        </svg>
        <span id="secTime" class="sr-only">30</span>
      </div>
    </div>
    <div id="defBox" class="def-box" style="margin:10px 0 8px"></div>
    <input id="secInput" type="text" placeholder="Type the word here…" autocomplete="off" />
    <div class="row" style="margin-top:10px">
      <button id="secStart" class="btn">Start 30-second Round</button>
      <button id="secSkip" class="btn secondary" disabled>Skip</button>
      <button id="secGive" class="btn warn" disabled>Give Answer</button>
      <span class="pill">Correct total: <span id="secTotal">0</span></span>
    </div>
    <div id="secFeedback" class="big" style="margin-top:8px"></div>
    <div id="secLast" class="muted" style="margin-top:6px"></div>
  </section>

  <!-- MILLIONAIRE -->
  <section id="million" class="card theming" style="display:none">
    <div class="grid-2">
      <div>
        <div class="row" style="justify-content:space-between;align-items:center">
          <div class="pill">Question <span id="milStep">1</span>/15</div>
          <div class="row">
            <span class="mil-cat"><span class="mil-dot" id="milDot" style="background:var(--theme)"></span><b id="milCat">—</b></span>
            <button id="mil5050" class="btn secondary">50:50</button>
            <button id="milSkip" class="btn secondary">Skip</button>
            <button id="milQuit" class="btn warn">Quit</button>
          </div>
        </div>
        <div id="milQ" class="def-box" style="margin-top:10px;font-weight:700"></div>
        <div class="opt" id="milOpts" style="margin-top:10px"></div>
        <div id="milFeedback" class="big" style="margin-top:10px"></div>
        <div class="row" style="margin-top:10px"><button id="milStart" class="btn">Start New Game</button></div>
      </div>
      <div><ul class="ladder" id="milLadder"></ul></div>
    </div>
  </section>

  <!-- ROAD RAGE -->
  <section id="driver" class="card" style="display:none">
    <div class="row hud" style="justify-content:space-between">
      <span class="pill">Stage: <b id="drvStageName">—</b></span>
      <span class="pill">Time Left: <b id="drvTime">100</b>s</span>
      <span class="pill">Distance: <b id="drvDist">0</b> m</span>
      <span class="pill">Speed: <b id="drvSpeed">50</b> m/s</span>
      <span class="pill">Score: <b id="drvScore">0</b></span>
      <span class="pill">Lives: <b id="drvLives">3</b></span>
      <button id="drvStart" class="btn">Start Run</button>
      <button id="drvPause" class="btn secondary">Pause</button>
    </div>
    <div style="position:relative;display:flex;justify-content:center">
      <canvas id="drvCanvas" width="360" height="540" style="border-radius:16px;border:1px solid rgba(255,255,255,.14)"></canvas>
      <div id="drvOverlay" class="overlayQ">
        <div class="overlayCard">
          <div class="big" id="drvQ">Question here</div>
          <div id="drvOpts" class="opt" style="margin-top:10px"></div>
        </div>
      </div>
      <div id="drvGameOver" class="gameOver">GAME OVER</div>
    </div>
    <div class="driver-controls">
      <button id="pedalAccel" class="pedal">⏫<br/><small>ACCELERATOR</small></button>
      <button id="pedalBrake" class="pedal">⏬<br/><small>BRAKE</small></button>
    </div>
  </section>

  <!-- STUDY -->
  <section id="study" class="card" style="display:none">
    <div class="subtabs">
      <button class="sub-btn active" data-sub="studyVocab">Vocabulary</button>
      <button class="sub-btn" data-sub="lotf">Lord of the Flies</button>
      <button class="sub-btn" data-sub="shakespeare">Shakespeare</button>
    </div>

    <div id="studyVocab">
      <div class="row">
        <input id="studySearch" type="text" placeholder="Search word/definition/example…">
        <button id="studyReset" class="btn secondary">Clear</button>
        <button id="studyPrint" class="btn">Print</button>
      </div>
      <div style="overflow:auto; max-height:60vh; margin-top:8px">
        <table id="studyTable"><thead><tr><th style="width:18%">Word</th><th style="width:37%">Definition</th><th>Example sentence</th></tr></thead><tbody></tbody></table>
      </div>
    </div>

    <div id="lotf" style="display:none">
      <div class="row">
        <button class="btn secondary" id="lotfAll">All</button>
        <button class="btn secondary" id="lotfPlot">Plot</button>
        <button class="btn secondary" id="lotfThemes">Themes</button>
        <button class="btn secondary" id="lotfChars">Characters</button>
        <button class="btn secondary" id="lotfSymbol">Symbolism</button>
        <button class="btn" id="lotfPrint">Print</button>
      </div>
      <div id="lotfList" style="max-height:60vh; overflow:auto; margin-top:8px"></div>
    </div>

    <div id="shakespeare" style="display:none">
      <div class="card" style="margin-bottom:10px">
        <div class="big"><b>Shakespeare Study Pack</b></div>
      </div>
      <div class="card" style="margin-bottom:10px">
        <div class="pill" style="margin-bottom:6px">Background & History</div>
        <ul style="margin:6px 0 0 18px">
          <li><b>Sonnet 18</b>: 1590s; printed 1609 Quarto; English sonnet scheme <b>ABAB CDCD EFEF GG</b>. Part of the “Fair Youth” sequence. The couplet asserts the poem preserves beauty beyond time.</li>
          <li><b>Romeo & Juliet Balcony</b>: c.1595. Staged with gallery/window; sets up the lovers’ decision to pursue love privately despite the feud and danger.</li>
        </ul>
      </div>
      <div id="shQA" style="max-height:26vh; overflow:auto; margin-bottom:10px;"></div>
      <h3>MCQ Practice</h3>
      <div id="shMCQ" style="max-height:24vh; overflow:auto; margin-bottom:10px;"></div>
      <h3>Short Answer Practice (with model answers)</h3>
      <div id="shSA" style="max-height:26vh; overflow:auto;"></div>
      <div class="row" style="margin-top:8px">
        <button id="shExpandAll" class="btn secondary">Expand all</button>
        <button id="shCollapseAll" class="btn secondary">Collapse all</button>
        <button id="shPrint" class="btn">Print</button>
      </div>
    </div>
  </section>
</div>

<div class="toast" id="toast">Saved</div>

<script>
/* ===== Polyfills ===== */
window.requestAnimationFrame = window.requestAnimationFrame || function(cb){return setTimeout(function(){cb(Date.now());},16);};
NodeList.prototype.forEach = NodeList.prototype.forEach || Array.prototype.forEach;

/* ===== Audio helpers ===== */
var AC;
function safeAC(){AC=AC||new (window.AudioContext||window.webkitAudioContext)(); return AC;}
function tone(f,d,type,g){try{
  var ac=safeAC(), o=ac.createOscillator(), v=ac.createGain();
  o.type=type; o.frequency.value=f; o.connect(v); v.connect(ac.destination);
  var t=ac.currentTime; v.gain.setValueAtTime(0.0001,t); v.gain.exponentialRampToValueAtTime(g||0.18,t+0.01);
  v.gain.exponentialRampToValueAtTime(0.0001,t+(d||0.2)); o.start(t); o.stop(t+(d||0.2)+0.02);
}catch(e){}}
function crashSound(){ try{
  var ac=safeAC(); var dur=0.25, n=ac.createBuffer(1, ac.sampleRate*dur, ac.sampleRate);
  var data=n.getChannelData(0); for(var i=0;i<data.length;i++){ data[i]=(Math.random()*2-1)*Math.pow(1-i/data.length,2); }
  var src=ac.createBufferSource(); src.buffer=n; var g=ac.createGain(); g.gain.value=0.25;
  var lp=ac.createBiquadFilter(); lp.type="lowpass"; lp.frequency.value=600;
  src.connect(lp); lp.connect(g); g.connect(ac.destination); src.start();
}catch(e){}}
function fanfare(){ try{
  var ac=safeAC(), t=ac.currentTime, seq=[[392,.16],[523,.16],[659,.16],[784,.28],[0,.08],[784,.16],[659,.16],[523,.16],[392,.28]];
  seq.reduce(function(at,s){ if(s[0]){var o=ac.createOscillator(), g=ac.createGain(); o.type="triangle"; o.frequency.value=s[0];
    o.connect(g); g.connect(ac.destination); g.gain.setValueAtTime(0.0001,at); g.gain.exponentialRampToValueAtTime(0.22,at+0.01);
    g.gain.exponentialRampToValueAtTime(0.0001,at+s[1]); o.start(at); o.stop(at+s[1]+.02);} return at+s[1]; }, t);
}catch(e){}}
function beep(kind){var m={ui:[420,0.09,"sine",0.12],open:[560,0.12,"triangle",0.14],ok:[660,0.18,"triangle",0.2],wrong:[200,0.18,"sawtooth",0.2],win:[880,0.25,"triangle",0.22],time:[300,0.18,"sine",0.18]};
  var s=m[kind||"ui"]; tone(s[0],s[1],s[2],s[3]); }
addEventListener("click",function(e){var el=e.target;if(el.closest&&(el.closest("button")||el.closest(".tab-btn")||el.closest(".sub-btn"))) beep("ui");});

/* ===== Splash & helpers ===== */
function $(id){return document.getElementById(id);}
function toast(msg){var t=$("toast");t.textContent=msg;t.classList.add("show");setTimeout(function(){t.classList.remove("show");},1200);}
function confetti(msg){for(var i=0;i<40;i++){var p=document.createElement("div");p.className="confetti-piece";p.style.background=["#00f5d4","#8a5cff","#ff5e57","#fca311","#2ecc71"][Math.floor(Math.random()*5)];p.style.left=(50+Math.random()*40-20)+"%";p.style.top="60%";p.style.transition="transform 1s ease-out, opacity 1.2s";document.body.appendChild(p);(function(p){setTimeout(function(){var dx=(Math.random()*2-1)*200,dy=-(200+Math.random()*300);p.style.transform="translate("+dx+"px,"+dy+"px) rotate("+Math.random()*360+"deg)";p.style.opacity=0;},10);setTimeout(function(){p.remove();},1200);})(p);}toast("🎉 "+msg);beep("win");}
var splash=$("splash");
function showSplash(cb){ splash.style.display="flex"; var h=splash.querySelector("h1"); h.style.animation="none"; void h.offsetWidth; h.style.animation="";
  setTimeout(function(){ splash.style.display="none"; if(typeof cb==="function") cb(); }, 2200); }

/* ===== Study/Millionaire data (abbrev for brevity) ===== */
var CAT_COLORS={"Sonnet 18":"#ff4d6d","Romeo & Juliet – Balcony":"#fca311","Lord of the Flies":"#2ecc71","Literary Devices":"#8a5cff","Parts of Speech":"#4da3ff"};
var TERMS=[{w:"sonnet",d:"A 14-line poem with a specific rhyme scheme.",e:"Shakespeare’s Sonnet 18 is a sonnet in iambic pentameter."},{w:"iambic pentameter",d:"A rhythm of five iambs per line.",e:"'Shall I compare thee' scans in iambic pentameter."},{w:"metaphor",d:"Direct comparison without 'like' or 'as'." ,e:"'Eye of heaven' is a metaphor for the sun."},{w:"personification",d:"Human traits to non-human things.",e:"'Death brag' personifies death."},{w:"oxymoron",d:"Contradictory terms together.",e:"'Brawling love' in Romeo and Juliet."},{w:"soliloquy",d:"Speech revealing inner thoughts.",e:"Juliet’s Act 3 soliloquy shows her anxiety."},{w:"dramatic irony",d:"Audience knows more than characters.",e:"We know Juliet isn’t dead; Romeo doesn’t."},{w:"symbolism",d:"Objects/actions representing ideas.",e:"The conch symbolises order."},{w:"microcosm",d:"Small system mirroring a larger one.",e:"The island is a microcosm of society."}];
var MCQ=[
  {cat:"Sonnet 18",q:"In Sonnet 18, the beloved is compared to a…",options:["Summer’s day","Winter’s night","Stormy sea","Rose"],correct:"Summer’s day"},
  {cat:"Sonnet 18",q:"'Eye of heaven' refers to the…",options:["Sun","Moon","Gods","Sky"],correct:"Sun"},
  {cat:"Romeo & Juliet – Balcony",q:"'Wherefore art thou Romeo?' means…",options:["Why are you Romeo?","Where are you?","Who are you?","When are you coming?"],correct:"Why are you Romeo?"},
  {cat:"Lord of the Flies",q:"What does the conch symbolise?",options:["Order and speech","Wealth","Romance","Religion"],correct:"Order and speech"},
  {cat:"Literary Devices",q:"Iambic pentameter has…",options:["Five iambs","Three trochees","Seven feet","Free rhythm"],correct:"Five iambs"}
];

/* ===== Stats ===== */
var KEY="g10_hub_v12";
function safeGet(k){try{return localStorage.getItem(k);}catch(e){return null}}
function safeSet(k,v){try{localStorage.setItem(k,v);}catch(e){}}
var STATS={merits:0,hangman:{wins:0},seconds:{fastest:null,total:0},million:{best:0,correct:0,answered:0},driver:{bestMeters:0}};
try{var s=safeGet(KEY);if(s){STATS=JSON.parse(s);} }catch(e){}
function saveStats(){safeSet(KEY,JSON.stringify(STATS));}
function refreshDash(){ $("s_merits").textContent=STATS.merits; $("s_hm_wins").textContent=STATS.hangman.wins;
  $("s_30_total").textContent=STATS.seconds.total; $("s_30_fast").textContent=STATS.seconds.fastest?(STATS.seconds.fastest/1000).toFixed(2)+"s":"—";
  $("s_mil_best").textContent=STATS.million.best+" / 15"; $("s_mil_correct").textContent=STATS.million.correct; $("s_mil_answered").textContent=STATS.million.answered;
  $("s_drv_best").textContent=STATS.driver.bestMeters+" m";
} refreshDash();

/* ===== Tabs & subtabs ===== */
var gameTabs=new Set(["hangman","seconds","million","driver","study"]);
document.querySelectorAll(".tab-btn").forEach(function(b){
  b.addEventListener("click",function(){
    document.querySelectorAll(".tab-btn").forEach(function(x){x.classList.remove("active");});
    b.classList.add("active");
    var target=b.getAttribute("data-tab"), next=$(target);
    var current=Array.from(document.querySelectorAll("section")).find(function(s){return s.style.display!=="none";});
    if(current===next) return;
    if(current){ current.style.opacity=0; setTimeout(function(){current.style.display="none";},300); }
    var show=function(){ next.style.display=""; next.style.opacity=0; requestAnimationFrame(function(){ next.style.opacity=1;}); };
    if(gameTabs.has(target)){ showSplash(show); } else { show(); }
    if(target!=="driver" && window.RoadRage && RoadRage.pause) RoadRage.pause();
  });
});
document.querySelectorAll(".sub-btn").forEach(function(b){
  b.addEventListener("click",function(){
    document.querySelectorAll(".sub-btn").forEach(function(x){x.classList.remove("active");});
    b.classList.add("active");
    var t=b.getAttribute("data-sub");
    ["studyVocab","lotf","shakespeare"].forEach(function(id){$(id).style.display=(id===t)?"":"none";});
  });
});

/* ===== Study builders (brief) ===== */
function buildStudy(){var tb=$("studyTable").querySelector("tbody");tb.innerHTML="";TERMS.forEach(function(t){var tr=document.createElement("tr");tr.innerHTML="<td><b>"+t.w+"</b></td><td>"+t.d+"</td><td><em>"+t.e+"</em></td>";tb.appendChild(tr);});}
function filterStudy(){var q=$("studySearch").value.toLowerCase();[].slice.call($("studyTable").querySelectorAll("tbody tr")).forEach(function(r){r.style.display=r.textContent.toLowerCase().indexOf(q)>-1?"":"none";});}
$("studySearch").addEventListener("input",filterStudy); $("studyReset").onclick=function(){ $("studySearch").value=""; filterStudy();}; $("studyPrint").onclick=function(){window.print();}; buildStudy();
function lotfRender(filter){var wrap=$("lotfList");wrap.innerHTML="";[{type:"Plot",text:"British schoolboys stranded…"}, {type:"Themes",text:"Civilisation vs Savagery…"}, {type:"Characters",text:"Ralph, Piggy, Jack, Simon, Roger."},{type:"Symbolism",text:"Conch, Signal Fire, Glasses, Painted Faces, Lord of the Flies."}]
  .filter(function(n){return !filter||filter==="All"||n.type===filter;})
  .forEach(function(n){var card=document.createElement("div");card.className="card";card.style.marginBottom="10px";card.innerHTML="<div class='pill' style='margin-bottom:6px'>"+n.type+"</div><div>"+n.text+"</div>";wrap.appendChild(card);});}
$("lotfAll").onclick=function(){lotfRender("All")}; $("lotfPlot").onclick=function(){lotfRender("Plot")}; $("lotfThemes").onclick=function(){lotfRender("Themes")}; $("lotfChars").onclick=function(){lotfRender("Characters")}; $("lotfSymbol").onclick=function(){lotfRender("Symbolism")}; $("lotfPrint").onclick=function(){window.print();}; lotfRender("All");

/* ===== Road Rage (5 lanes, tilt + pedals, stages, fair traffic) ===== */
var RoadRage=(function(){
  var cvs=$("drvCanvas"), ctx=cvs.getContext("2d"), DPR=1, W=360, H=540;

  // CONFIG
  var lanes=5, roadMargin=0.16; // wider road, 5 lanes
  var pxBase=220;               // baseline scroll speed for 50 m/s
  var STIFF=12, DAMP=7;         // lateral spring-damper
  var MAX_SPEED=250, MIN_SPEED=30;
  var OB_CLUSTER_P=0.0036;      // ~80% reduced from earlier (~0.018)
  var BOOST_P=0.002;            // rarer boost
  var OIL_P=0.0025;             // oil slick spawn
  var STAGE_TIME=100;           // seconds per stage
  var VEH_TYPES=[
    {t:"car",  w:34,h:52, color:"#ffffff", vf:1.00},
    {t:"bus",  w:44,h:80, color:"#ffd166", vf:0.90},
    {t:"truck",w:44,h:74, color:"#9ad0ff", vf:0.95},
    {t:"bike", w:24,h:44, color:"#a4ff9a", vf:0.80},
    {t:"super",w:36,h:48, color:"#ff5e57", vf:1.15},
    {t:"moto", w:18,h:36, color:"#ffb3c1", vf:1.10}
  ];
  var STAGES=[
    {name:"Mountainous",  road:"#11243f", dash:"#fca311", sky:"#041225"},
    {name:"Farmland",     road:"#0e2a1c", dash:"#b7e07e", sky:"#02150b"},
    {name:"Dirt Road",    road:"#3b2a16", dash:"#e1b382", sky:"#120a04"},
    {name:"City",         road:"#1a1f2c", dash:"#9ad0ff", sky:"#0b0d16"},
    {name:"Suburbs",      road:"#1c2631", dash:"#bcd1ff", sky:"#0c1420"},
    {name:"Ghetto",       road:"#2a1c24", dash:"#ff8aa1", sky:"#12070c"},
    {name:"Futuristic",   road:"#101c36", dash:"#00f5d4", sky:"#030b1a"}
  ];

  // STATE
  var laneX=[], dashes=[];
  var running=false, paused=false, last=0, meters=0, speed=50, score=0;
  var stageIdx=0, stageStart=0, timeLeft=STAGE_TIME;
  var pickup=null, obstacles=[], boosts=[], oils=[];
  var lives=3, respawn=false, respawnTimer=null, slipTime=0, slipDir=0;
  var player={lane:2, y:0, color:"#00f5d4", visible:true}; // start middle lane of 5
  var targetLane=2, laneVel=0;

  // INPUT
  var sx=null; // swipe
  var tiltEnabled=false, tiltGamma=0, tiltZero=null;
  function enableTilt(){
    try{
      if(typeof DeviceOrientationEvent!=="undefined"){
        if(DeviceOrientationEvent.requestPermission){
          DeviceOrientationEvent.requestPermission().then(function(s){ if(s==="granted"){window.addEventListener("deviceorientation",onOri,true); tiltEnabled=true;}});
        }else{ window.addEventListener("deviceorientation",onOri,true); tiltEnabled=true; }
      }
    }catch(e){}
  }
  function onOri(e){ if(typeof e.gamma==="number"){ if(tiltZero===null) tiltZero=e.gamma; tiltGamma=e.gamma-tiltZero; } }

  // KEYBOARD (fixed + preventDefault)
  window.addEventListener("keydown",function(e){
    if(e.key==="ArrowLeft"){ e.preventDefault(); left(); }
    if(e.key==="ArrowRight"){ e.preventDefault(); right(); }
  });

  // RESPONSIVE CANVAS
  function dprScale(){
    var vw=window.innerWidth, vh=window.innerHeight;
    var maxH = Math.floor(vh*0.78);
    var cssH = Math.min(660, maxH);
    var cssW = Math.floor(cssH * (2/3));
    cssW = Math.min(cssW, Math.floor(vw*0.94));
    cssH = Math.min(cssH, Math.floor(cssW*1.5));
    cvs.style.width=cssW+"px"; cvs.style.height=cssH+"px";
    DPR = window.devicePixelRatio || 1;
    W = cssW; H = cssH; cvs.width=Math.floor(cssW*DPR); cvs.height=Math.floor(cssH*DPR); ctx.setTransform(DPR,0,0,DPR,0,0);
    var left=W*roadMargin, right=W*(1-roadMargin), inner=right-left;
    laneX=[]; for(var i=0;i<lanes;i++) laneX.push(left+inner*((i+0.5)/lanes));
    dashes=[]; for(var y=0;y<H;y+=60) dashes.push({y:y});
    pxBase = H/2.6;
    player.y=Math.floor(H*0.86);
    draw();
  }
  window.addEventListener("resize",dprScale);
  window.addEventListener("orientationchange",function(){setTimeout(dprScale,200);});

  // DRAWING
  function rr(x,y,w,h,r){if(r>w/2)r=w/2;if(r>h/2)r=h/2;ctx.beginPath();ctx.moveTo(x+r,y);ctx.lineTo(x+w-r,y);ctx.quadraticCurveTo(x+w,y,x+w,y+r);ctx.lineTo(x+w,y+h-r);ctx.quadraticCurveTo(x+w,y+h,x+w-r,y+h);ctx.lineTo(x+r,y+h);ctx.quadraticCurveTo(x,y+h,x,y+h-r);ctx.lineTo(x,y+r);ctx.quadraticCurveTo(x,y,x+r,y);ctx.closePath();}
  function drawVehicle(cx,cy,vt){var w=vt.w,h=vt.h,x=cx-w/2,y=cy-h/2;ctx.fillStyle=vt.color;ctx.strokeStyle="#233";ctx.lineWidth=2;rr(x,y,w,h,8);ctx.fill();ctx.stroke();ctx.fillStyle="#071018";rr(x+6,y+6,w-12,14,4);ctx.fill();}
  function drawOil(cx,cy){ctx.fillStyle="#111";ctx.beginPath();ctx.ellipse(cx,cy,14,8,0,0,Math.PI*2);ctx.fill();ctx.strokeStyle="#222";ctx.stroke();}
  function drawBoost(cx,cy){ctx.fillStyle="#2ecc71";ctx.beginPath();ctx.arc(cx,cy,12,0,Math.PI*2);ctx.fill();ctx.fillStyle="#061314";ctx.font="bold 14px Arial";ctx.textAlign="center";ctx.textBaseline="middle";ctx.fillText("+",cx,cy+1);}

  function stageTheme(){return STAGES[stageIdx % STAGES.length];}

  function draw(){
    var th=stageTheme();
    // background sky tint
    ctx.fillStyle=th.sky; ctx.fillRect(0,0,W,H);
    var left=W*roadMargin,right=W*(1-roadMargin);
    ctx.fillStyle=th.road; ctx.fillRect(left,0,right-left,H);
    // lane markers
    ctx.strokeStyle="#cfe7ff"; ctx.setLineDash([12,12]); ctx.lineWidth=2;
    for(var i=1;i<lanes;i++){ var x=left+(right-left)*i/lanes; ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,H); ctx.stroke(); }
    ctx.setLineDash([]);
    // scrolling dashes across road (horizon stripes)
    ctx.strokeStyle=th.dash; ctx.lineWidth=6;
    for(var i=0;i<dashes.length;i++){ ctx.beginPath(); ctx.moveTo(left+20,dashes[i].y); ctx.lineTo(right-20,dashes[i].y); ctx.stroke(); }

    // objects
    for(i=0;i<oils.length;i++) drawOil(laneX[oils[i].lane], oils[i].y);
    for(i=0;i<obstacles.length;i++){ var ob=obstacles[i]; drawVehicle(laneX[ob.lane], ob.y, ob.vt); }
    for(i=0;i<boosts.length;i++) drawBoost(laneX[boosts[i].lane], boosts[i].y);

    // player
    var step=(laneX[1]-laneX[0]), px=laneX[0] + step*player.lane;
    if(player.visible) drawVehicle(px, player.y, {w:34,h:54,color:player.color});
  }

  // ENGINE SOUND (heavier)
  var engine=null;
  function engineStart(){
    try{
      var ac=safeAC(); if(ac.state==="suspended"){ ac.resume(); }
      var o1=ac.createOscillator(); o1.type="sawtooth";
      var o2=ac.createOscillator(); o2.type="square"; // sub
      var g=ac.createGain(); g.gain.value=0.0;
      var lp=ac.createBiquadFilter(); lp.type="lowpass"; lp.frequency.value=1000;
      o1.connect(lp); o2.connect(lp); lp.connect(g); g.connect(ac.destination);
      o1.start(); o2.start();
      engine={o1:o1,o2:o2,g:g,lp:lp};
    }catch(e){ engine=null; }
  }
  function engineStop(){ try{ if(engine){ engine.o1.stop(); engine.o2.stop(); engine.g.disconnect(); engine=null; } }catch(e){} }
  function engineUpdate(){
    if(!engine||!AC) return;
    var f = 60 + speed*1.6;          // heavier base
    var vol = (running? 0.05 + Math.min(0.12, speed/MAX_SPEED*0.12) : 0.0);
    engine.o1.frequency.setTargetAtTime(f, AC.currentTime, 0.05);
    engine.o2.frequency.setTargetAtTime(f/2, AC.currentTime, 0.05);
    engine.g.gain.setTargetAtTime(vol, AC.currentTime, 0.05);
  }

  // GAME LOOP
  function update(ts){
    if(!running){ last=ts; engineUpdate(); return; }
    var dt=(ts-last)/1000; last=ts;

    // stage timer
    timeLeft = Math.max(0, STAGE_TIME - (ts - stageStart)/1000); $("drvTime").textContent=Math.ceil(timeLeft);
    if(timeLeft<=0){ nextStageQuiz(); return; }

    // inputs: tilt steering adjusts target (gentle)
    if(tiltEnabled){ var t = 2 + Math.max(-2, Math.min(2, (tiltGamma/15))); targetLane = Math.max(0, Math.min(lanes-1, t)); }

    // oil slip
    if(slipTime>0){ slipTime-=dt; laneVel += (slipDir*0.8)*dt; }

    // spring-damper to target lane
    var a = STIFF*(targetLane - player.lane) - DAMP*laneVel; laneVel += a*dt; player.lane += laneVel*dt;
    if(player.lane<0){player.lane=0; laneVel=0} if(player.lane>lanes-1){player.lane=lanes-1; laneVel=0}

    // scroll ground
    var pxPerSec = pxBase * (speed/50);
    for(var i=0;i<dashes.length;i++){dashes[i].y+=pxPerSec*dt; if(dashes[i].y>H)dashes[i].y-=H;}
    meters += speed*dt; $("drvDist").textContent=Math.floor(meters); $("drvSpeed").textContent=Math.floor(speed);

    // SPAWN: cluster obstacles leaving at least 1 free lane
    if(Math.random()<OB_CLUSTER_P){
      var y0 = -40; var lanesFree=[0,1,2,3,4];
      var count = 1 + Math.floor(Math.random()*3); // 1–3 vehicles in a row
      if(count >= lanes) count = lanes-1;
      for(var c=0;c<count;c++){
        var li = lanesFree.splice(Math.floor(Math.random()*lanesFree.length),1)[0];
        var vt = VEH_TYPES[Math.floor(Math.random()*VEH_TYPES.length)];
        obstacles.push({lane:li, y:y0, vt:vt, vf:vt.vf});
      }
    }
    if(Math.random()<BOOST_P){ boosts.push({lane:Math.floor(Math.random()*lanes), y:-40}); }
    if(Math.random()<OIL_P){ oils.push({lane:Math.floor(Math.random()*lanes), y:-30}); }

    // Move objects
    for(var i=obstacles.length-1;i>=0;i--){var ob=obstacles[i]; ob.y += pxPerSec*ob.vf*dt; if(ob.y>H+80) obstacles.splice(i,1);}
    for(i=boosts.length-1;i>=0;i--){boosts[i].y += pxPerSec*dt; if(boosts[i].y>H+40) boosts.splice(i,1);}
    for(i=oils.length-1;i>=0;i--){oils[i].y += pxPerSec*dt; if(oils[i].y>H+40) oils.splice(i,1);}

    // collisions
    var step=(laneX[1]-laneX[0]), px=laneX[0] + step*player.lane;
    var XTH=24, YTH=40;
    if(!respawn){
      // obstacles (vehicles)
      for(i=obstacles.length-1;i>=0;i--){var ob2=obstacles[i]; if(Math.abs(laneX[ob2.lane]-px)<(ob2.vt.w/2+XTH) && Math.abs(ob2.y-player.y)<(ob2.vt.h/2+YTH)){ crash(); obstacles.splice(i,1); break;}}
      // boost
      for(i=boosts.length-1;i>=0;i--){var b=boosts[i]; if(Math.abs(laneX[b.lane]-px)<XTH && Math.abs(b.y-player.y)<YTH){ boosts.splice(i,1); speed=Math.min(MAX_SPEED, speed+25); toast("⚡ +25 m/s → "+Math.floor(speed)); beep("ok"); }}
      // oil
      for(i=oils.length-1;i>=0;i--){var o=oils[i]; if(Math.abs(laneX[o.lane]-px)<XTH && Math.abs(o.y-player.y)<YTH){ oils.splice(i,1); slipTime=1.0; slipDir = Math.random()<0.5? -1:1; toast("🛢️ Oil!"); }}
    }

    engineUpdate();
    draw(); requestAnimationFrame(update);
  }

  function crash(){
    lives--; $("drvLives").textContent=lives; player.visible=false; respawn=true; engineStop(); crashSound();
    speed=Math.max(MIN_SPEED, speed-40);
    if(lives<=0){ gameOver(); return; }
    if(respawnTimer) clearTimeout(respawnTimer);
    respawnTimer=setTimeout(function(){ player.visible=true; respawn=false; }, 1000);
  }

  function gameOver(){
    running=false; $("drvGameOver").style.display="flex"; engineStop();
    STATS.driver.bestMeters=Math.max(STATS.driver.bestMeters,Math.floor(meters)); saveStats(); refreshDash();
  }

  // ===== Stage/Quiz =====
  function startStage(idx){
    stageIdx = idx % STAGES.length;
    $("drvStageName").textContent = STAGES[stageIdx].name;
    stageStart = performance.now(); timeLeft = STAGE_TIME;
  }
  function nextStageQuiz(){
    running=false; engineStop(); // pause motion & audio
    askStageQuestions(3, function(){ // after 3 Qs, go to next stage
      stageIdx = (stageIdx+1) % STAGES.length;
      startStage(stageIdx); run();
    });
  }
  function askStageQuestions(n, done){
    var overlay=$("drvOverlay"); overlay.style.display="flex";
    var asked=0, points=0;
    function askOne(){
      if(asked>=n){ overlay.style.display="none"; confetti("Stage complete! +"+points+" pts"); if(typeof done==="function") done(); return; }
      var q=MCQ[Math.floor(Math.random()*MCQ.length)];
      document.documentElement.style.setProperty("--theme", CAT_COLORS[q.cat]||"#8a5cff");
      $("drvQ").innerHTML="<div class='pill' style='margin-bottom:6px;display:inline-flex;gap:8px;align-items:center'><span style='width:10px;height:10px;border-radius:50%;background:"+ (CAT_COLORS[q.cat]||"#8a5cff")+"'></span>"+q.cat+"</div>"+q.q;
      var box=$("drvOpts"); box.innerHTML="";
      q.options.slice().sort(function(){return Math.random()-0.5;}).forEach(function(opt){
        var btn=document.createElement("button"); btn.className="btn secondary"; btn.textContent=opt;
        btn.onclick=function(){
          if(opt===q.correct){ points+=150; $("drvScore").textContent = (score+=150); confetti("Correct!"); }
          else{ toast("Answer: "+q.correct); }
          asked++; askOne();
        };
        box.appendChild(btn);
      });
    }
    askOne();
  }

  // CONTROLS
  function left(){ targetLane=Math.max(0, targetLane-1); beep("open"); }
  function right(){ targetLane=Math.min(lanes-1, targetLane+1); beep("open"); }

  // Pedals (press & hold)
  function hold(el, on, off){
    var tid=null, active=false, rep=function(){ on(); tid=requestAnimationFrame(rep); };
    function down(e){ e.preventDefault(); if(active) return; active=true; on(); tid=requestAnimationFrame(rep); }
    function up(){ if(!active) return; active=false; cancelAnimationFrame(tid); if(off) off(); }
    el.addEventListener("touchstart",down,{passive:false}); el.addEventListener("mousedown",down);
    ["touchend","touchcancel","mouseup","mouseleave"].forEach(function(evt){ el.addEventListener(evt,up); });
  }
  hold($("pedalAccel"), function(){ if(running){ speed=Math.min(MAX_SPEED, speed+80/60); }}, null);
  hold($("pedalBrake"), function(){ if(running){ speed=Math.max(MIN_SPEED, speed-120/60); }}, null);

  // swipe and canvas tap left/right
  cvs.addEventListener("touchstart",function(e){sx=e.touches[0].clientX;});
  cvs.addEventListener("touchend",function(e){if(sx===null)return;var dx=e.changedTouches[0].clientX-sx;if(dx<-20)left();else if(dx>20)right();sx=null;});

  // PUBLIC controls
  function run(){ $("drvGameOver").style.display="none"; running=true; paused=false; last=performance.now(); engineStart(); requestAnimationFrame(update); }
  function pause(){ running=false; paused=true; engineStop(); }

  // Buttons
  $("drvStart").onclick=function(){ reset(); enableTilt(); startStage(0); run(); };
  $("drvPause").onclick=pause;

  // RESET
  function reset(){
    meters=0; score=0; $("drvScore").textContent=0; $("drvDist").textContent=0; $("drvLives").textContent=(lives=3);
    pickup=null; obstacles=[]; boosts=[]; oils=[]; player.lane=2; targetLane=2; laneVel=0; speed=50; slipTime=0; slipDir=0; tiltZero=null;
    $("drvTime").textContent=STAGE_TIME; $("drvStageName").textContent="—";
    $("drvGameOver").style.display="none"; dprScale(); draw(); engineStop();
  }

  dprScale(); reset();
  return {pause:pause};
})();
</script>
</body>
</html>
